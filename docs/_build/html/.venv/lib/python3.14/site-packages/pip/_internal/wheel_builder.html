

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/wheel_builder.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>“””Orchestrator for building wheels from InstallRequirements.”””</p>
<p>from <strong>future</strong> import annotations</p>
<p>import logging
import os.path
import re
from collections.abc import Iterable
from tempfile import TemporaryDirectory</p>
<p>from pip._vendor.packaging.utils import canonicalize_name, canonicalize_version
from pip._vendor.packaging.version import InvalidVersion, Version</p>
<p>from pip._internal.cache import WheelCache
from pip._internal.exceptions import InvalidWheelFilename, UnsupportedWheel
from pip._internal.metadata import FilesystemWheel, get_wheel_distribution
from pip._internal.models.link import Link
from pip._internal.models.wheel import Wheel
from pip._internal.operations.build.wheel import build_wheel_pep517
from pip._internal.operations.build.wheel_editable import build_wheel_editable
from pip._internal.req.req_install import InstallRequirement
from pip._internal.utils.logging import indent_log
from pip._internal.utils.misc import ensure_dir, hash_file
from pip._internal.utils.urls import path_to_url
from pip._internal.vcs import vcs</p>
<p>logger = logging.getLogger(<strong>name</strong>)</p>
<p><em>egg_info_re = re.compile(r”([a-z0-9</em>.]+)-([a-z0-9_.!+-]+)”, re.IGNORECASE)</p>
<p>BuildResult = tuple[list[InstallRequirement], list[InstallRequirement]]</p>
<p>def _contains_egg_info(s: str) -&gt; bool:
“””Determine whether the string looks like an egg_info.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>:param s: The string to parse. E.g. foo-2.1
&quot;&quot;&quot;
return bool(_egg_info_re.search(s))
</pre></div>
</div>
<p>def _should_cache(
req: InstallRequirement,
) -&gt; bool | None:
“””
Return whether a built InstallRequirement can be stored in the persistent
wheel cache, assuming the wheel cache is available.
“””
if req.editable or not req.source_dir:
# never cache editable requirements
return False</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if req.link and req.link.is_vcs:
    # VCS checkout. Do not cache
    # unless it points to an immutable commit hash.
    assert not req.editable
    assert req.source_dir
    vcs_backend = vcs.get_backend_for_scheme(req.link.scheme)
    assert vcs_backend
    if vcs_backend.is_immutable_rev_checkout(req.link.url, req.source_dir):
        return True
    return False

assert req.link
base, ext = req.link.splitext()
if _contains_egg_info(base):
    return True

# Otherwise, do not cache.
return False
</pre></div>
</div>
<p>def _get_cache_dir(
req: InstallRequirement,
wheel_cache: WheelCache,
) -&gt; str:
“””Return the persistent or temporary cache directory where the built
wheel need to be stored.
“””
cache_available = bool(wheel_cache.cache_dir)
assert req.link
if cache_available and _should_cache(req):
cache_dir = wheel_cache.get_path_for_link(req.link)
else:
cache_dir = wheel_cache.get_ephem_path_for_link(req.link)
return cache_dir</p>
<p>def _verify_one(req: InstallRequirement, wheel_path: str) -&gt; None:
canonical_name = canonicalize_name(req.name or “”)
w = Wheel(os.path.basename(wheel_path))
if w.name != canonical_name:
raise InvalidWheelFilename(
f”Wheel has unexpected file name: expected {canonical_name!r}, “
f”got {w.name!r}”,
)
dist = get_wheel_distribution(FilesystemWheel(wheel_path), canonical_name)
dist_verstr = str(dist.version)
if canonicalize_version(dist_verstr) != canonicalize_version(w.version):
raise InvalidWheelFilename(
f”Wheel has unexpected file name: expected {dist_verstr!r}, “
f”got {w.version!r}”,
)
metadata_version_value = dist.metadata_version
if metadata_version_value is None:
raise UnsupportedWheel(“Missing Metadata-Version”)
try:
metadata_version = Version(metadata_version_value)
except InvalidVersion:
msg = f”Invalid Metadata-Version: {metadata_version_value}”
raise UnsupportedWheel(msg)
if metadata_version &gt;= Version(“1.2”) and not isinstance(dist.version, Version):
raise UnsupportedWheel(
f”Metadata 1.2 mandates PEP 440 version, but {dist_verstr!r} is not”
)</p>
<p>def _build_one(
req: InstallRequirement,
output_dir: str,
verify: bool,
editable: bool,
) -&gt; str | None:
“””Build one wheel.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>:return: The filename of the built wheel, or None if the build failed.
&quot;&quot;&quot;
artifact = &quot;editable&quot; if editable else &quot;wheel&quot;
try:
    ensure_dir(output_dir)
except OSError as e:
    logger.warning(
        &quot;Building %s for %s failed: %s&quot;,
        artifact,
        req.name,
        e,
    )
    return None

# Install build deps into temporary directory (PEP 518)
with req.build_env:
    wheel_path = _build_one_inside_env(req, output_dir, editable)
if wheel_path and verify:
    try:
        _verify_one(req, wheel_path)
    except (InvalidWheelFilename, UnsupportedWheel) as e:
        logger.warning(&quot;Built %s for %s is invalid: %s&quot;, artifact, req.name, e)
        return None
return wheel_path
</pre></div>
</div>
<p>def _build_one_inside_env(
req: InstallRequirement,
output_dir: str,
editable: bool,
) -&gt; str | None:
with TemporaryDirectory(dir=output_dir) as wheel_directory:
assert req.name
assert req.metadata_directory
assert req.pep517_backend
if editable:
wheel_path = build_wheel_editable(
name=req.name,
backend=req.pep517_backend,
metadata_directory=req.metadata_directory,
wheel_directory=wheel_directory,
)
else:
wheel_path = build_wheel_pep517(
name=req.name,
backend=req.pep517_backend,
metadata_directory=req.metadata_directory,
wheel_directory=wheel_directory,
)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    if wheel_path is not None:
        wheel_name = os.path.basename(wheel_path)
        dest_path = os.path.join(output_dir, wheel_name)
        try:
            wheel_hash, length = hash_file(wheel_path)
            # We can do a replace here because wheel_path is guaranteed to
            # be in the same filesystem as output_dir. This will perform an
            # atomic rename, which is necessary to avoid concurrency issues
            # when populating the cache.
            os.replace(wheel_path, dest_path)
            logger.info(
                &quot;Created wheel for %s: filename=%s size=%d sha256=%s&quot;,
                req.name,
                wheel_name,
                length,
                wheel_hash.hexdigest(),
            )
            logger.info(&quot;Stored in directory: %s&quot;, output_dir)
            return dest_path
        except Exception as e:
            logger.warning(
                &quot;Building wheel for %s failed: %s&quot;,
                req.name,
                e,
            )
    return None
</pre></div>
</div>
<p>def build(
requirements: Iterable[InstallRequirement],
wheel_cache: WheelCache,
verify: bool,
) -&gt; BuildResult:
“””Build wheels.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>:return: The list of InstallRequirement that succeeded to build and
    the list of InstallRequirement that failed to build.
&quot;&quot;&quot;
if not requirements:
    return [], []

# Build the wheels.
logger.info(
    &quot;Building wheels for collected packages: %s&quot;,
    &quot;, &quot;.join(req.name for req in requirements),  # type: ignore
)

with indent_log():
    build_successes, build_failures = [], []
    for req in requirements:
        assert req.name
        cache_dir = _get_cache_dir(req, wheel_cache)
        wheel_file = _build_one(
            req,
            cache_dir,
            verify,
            req.editable and req.permit_editable_wheels,
        )
        if wheel_file:
            # Record the download origin in the cache
            if req.download_info is not None:
                # download_info is guaranteed to be set because when we build an
                # InstallRequirement it has been through the preparer before, but
                # let&#39;s be cautious.
                wheel_cache.record_download_origin(cache_dir, req.download_info)
            # Update the link for this.
            req.link = Link(path_to_url(wheel_file))
            req.local_file_path = req.link.file_path
            assert req.link.is_wheel
            build_successes.append(req)
        else:
            build_failures.append(req)

# notify success/failure
if build_successes:
    logger.info(
        &quot;Successfully built %s&quot;,
        &quot; &quot;.join([req.name for req in build_successes]),  # type: ignore
    )
if build_failures:
    logger.info(
        &quot;Failed to build %s&quot;,
        &quot; &quot;.join([req.name for req in build_failures]),  # type: ignore
    )
# Return a list of requirements that failed to build
return build_successes, build_failures
</pre></div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>