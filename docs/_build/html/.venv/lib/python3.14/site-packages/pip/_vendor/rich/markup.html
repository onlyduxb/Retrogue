

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_vendor/rich/markup.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>import re
from ast import literal_eval
from operator import attrgetter
from typing import Callable, Iterable, List, Match, NamedTuple, Optional, Tuple, Union</p>
<p>from ._emoji_replace import _emoji_replace
from .emoji import EmojiVariant
from .errors import MarkupError
from .style import Style
from .text import Span, Text</p>
<p>RE_TAGS = re.compile(
r”””((\<em>)[([a-z#/&#64;]<a href="#id4"><span class="problematic" id="id1">[^[]</span></a></em>?)])”””,
re.VERBOSE,
)</p>
<p>RE_HANDLER = re.compile(r”^([\w.]<em>?)((.</em>?))?$”)</p>
<p>class Tag(NamedTuple):
“””A tag in console markup.”””</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>name: str
&quot;&quot;&quot;The tag name. e.g. &#39;bold&#39;.&quot;&quot;&quot;
parameters: Optional[str]
&quot;&quot;&quot;Any additional parameters after the name.&quot;&quot;&quot;

def __str__(self) -&gt; str:
    return (
        self.name if self.parameters is None else f&quot;{self.name} {self.parameters}&quot;
    )

@property
def markup(self) -&gt; str:
    &quot;&quot;&quot;Get the string representation of this tag.&quot;&quot;&quot;
    return (
        f&quot;[{self.name}]&quot;
        if self.parameters is None
        else f&quot;[{self.name}={self.parameters}]&quot;
    )
</pre></div>
</div>
<p>_ReStringMatch = Match[str]  # regex match object
_ReSubCallable = Callable[[_ReStringMatch], str]  # Callable invoked by re.sub
_EscapeSubMethod = Callable[[_ReSubCallable, str], str]  # Sub method of a compiled re</p>
<p>def escape(
markup: str,
_escape: _EscapeSubMethod = re.compile(r”(\<em>)([[a-z#/&#64;]<a href="#id5"><span class="problematic" id="id2">[^[]</span></a></em>?])”).sub,
) -&gt; str:
“””Escapes text so that it won’t be interpreted as markup.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Args:
    markup (str): Content to be inserted in to markup.

Returns:
    str: Markup with square brackets escaped.
&quot;&quot;&quot;

def escape_backslashes(match: Match[str]) -&gt; str:
    &quot;&quot;&quot;Called by re.sub replace matches.&quot;&quot;&quot;
    backslashes, text = match.groups()
    return f&quot;{backslashes}{backslashes}\\{text}&quot;

markup = _escape(escape_backslashes, markup)
if markup.endswith(&quot;\\&quot;) and not markup.endswith(&quot;\\\\&quot;):
    return markup + &quot;\\&quot;

return markup
</pre></div>
</div>
<p>def _parse(markup: str) -&gt; Iterable[Tuple[int, Optional[str], Optional[Tag]]]:
“””Parse markup in to an iterable of tuples of (position, text, tag).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Args:
    markup (str): A string containing console markup

&quot;&quot;&quot;
position = 0
_divmod = divmod
_Tag = Tag
for match in RE_TAGS.finditer(markup):
    full_text, escapes, tag_text = match.groups()
    start, end = match.span()
    if start &gt; position:
        yield start, markup[position:start], None
    if escapes:
        backslashes, escaped = _divmod(len(escapes), 2)
        if backslashes:
            # Literal backslashes
            yield start, &quot;\\&quot; * backslashes, None
            start += backslashes * 2
        if escaped:
            # Escape of tag
            yield start, full_text[len(escapes) :], None
            position = end
            continue
    text, equals, parameters = tag_text.partition(&quot;=&quot;)
    yield start, None, _Tag(text, parameters if equals else None)
    position = end
if position &lt; len(markup):
    yield position, markup[position:], None
</pre></div>
</div>
<p>def render(
markup: str,
style: Union[str, Style] = “”,
emoji: bool = True,
emoji_variant: Optional[EmojiVariant] = None,
) -&gt; Text:
“””Render console markup in to a Text instance.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Args:
    markup (str): A string containing console markup.
    style: (Union[str, Style]): The style to use.
    emoji (bool, optional): Also render emoji code. Defaults to True.
    emoji_variant (str, optional): Optional emoji variant, either &quot;text&quot; or &quot;emoji&quot;. Defaults to None.


Raises:
    MarkupError: If there is a syntax error in the markup.

Returns:
    Text: A test instance.
&quot;&quot;&quot;
emoji_replace = _emoji_replace
if &quot;[&quot; not in markup:
    return Text(
        emoji_replace(markup, default_variant=emoji_variant) if emoji else markup,
        style=style,
    )
text = Text(style=style)
append = text.append
normalize = Style.normalize

style_stack: List[Tuple[int, Tag]] = []
pop = style_stack.pop

spans: List[Span] = []
append_span = spans.append

_Span = Span
_Tag = Tag

def pop_style(style_name: str) -&gt; Tuple[int, Tag]:
    &quot;&quot;&quot;Pop tag matching given style name.&quot;&quot;&quot;
    for index, (_, tag) in enumerate(reversed(style_stack), 1):
        if tag.name == style_name:
            return pop(-index)
    raise KeyError(style_name)

for position, plain_text, tag in _parse(markup):
    if plain_text is not None:
        # Handle open brace escapes, where the brace is not part of a tag.
        plain_text = plain_text.replace(&quot;\\[&quot;, &quot;[&quot;)
        append(emoji_replace(plain_text) if emoji else plain_text)
    elif tag is not None:
        if tag.name.startswith(&quot;/&quot;):  # Closing tag
            style_name = tag.name[1:].strip()

            if style_name:  # explicit close
                style_name = normalize(style_name)
                try:
                    start, open_tag = pop_style(style_name)
                except KeyError:
                    raise MarkupError(
                        f&quot;closing tag &#39;{tag.markup}&#39; at position {position} doesn&#39;t match any open tag&quot;
                    ) from None
            else:  # implicit close
                try:
                    start, open_tag = pop()
                except IndexError:
                    raise MarkupError(
                        f&quot;closing tag &#39;[/]&#39; at position {position} has nothing to close&quot;
                    ) from None

            if open_tag.name.startswith(&quot;@&quot;):
                if open_tag.parameters:
                    handler_name = &quot;&quot;
                    parameters = open_tag.parameters.strip()
                    handler_match = RE_HANDLER.match(parameters)
                    if handler_match is not None:
                        handler_name, match_parameters = handler_match.groups()
                        parameters = (
                            &quot;()&quot; if match_parameters is None else match_parameters
                        )

                    try:
                        meta_params = literal_eval(parameters)
                    except SyntaxError as error:
                        raise MarkupError(
                            f&quot;error parsing {parameters!r} in {open_tag.parameters!r}; {error.msg}&quot;
                        )
                    except Exception as error:
                        raise MarkupError(
                            f&quot;error parsing {open_tag.parameters!r}; {error}&quot;
                        ) from None

                    if handler_name:
                        meta_params = (
                            handler_name,
                            meta_params
                            if isinstance(meta_params, tuple)
                            else (meta_params,),
                        )

                else:
                    meta_params = ()

                append_span(
                    _Span(
                        start, len(text), Style(meta={open_tag.name: meta_params})
                    )
                )
            else:
                append_span(_Span(start, len(text), str(open_tag)))

        else:  # Opening tag
            normalized_tag = _Tag(normalize(tag.name), tag.parameters)
            style_stack.append((len(text), normalized_tag))

text_length = len(text)
while style_stack:
    start, tag = style_stack.pop()
    style = str(tag)
    if style:
        append_span(_Span(start, text_length, style))

text.spans = sorted(spans[::-1], key=attrgetter(&quot;start&quot;))
return text
</pre></div>
</div>
<p>if <strong>name</strong> == “<strong>main</strong>”:  # pragma: no cover
MARKUP = [
“[red]Hello World[/red]”,
“[magenta]Hello [b]World[/b]”,
“[bold]Bold[italic] bold and italic [/bold]italic[/italic]”,
“Click [link=https://www.willmcgugan.com]here[/link] to visit my Blog”,
“:warning-emoji: [bold red blink] DANGER![/]”,
]</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>from pip._vendor.rich import print
from pip._vendor.rich.table import Table

grid = Table(&quot;Markup&quot;, &quot;Result&quot;, padding=(0, 1))

for markup in MARKUP:
    grid.add_row(Text(markup), markup)

print(grid)
</pre></div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>