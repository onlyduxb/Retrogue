

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shorthands &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Shorthands</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/operations/check.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>“””Validation of dependencies of packages”””</p>
<p>from <strong>future</strong> import annotations</p>
<p>import logging
from collections.abc import Generator, Iterable
from contextlib import suppress
from email.parser import Parser
from functools import reduce
from typing import (
Callable,
NamedTuple,
)</p>
<p>from pip._vendor.packaging.requirements import Requirement
from pip._vendor.packaging.tags import Tag, parse_tag
from pip._vendor.packaging.utils import NormalizedName, canonicalize_name
from pip._vendor.packaging.version import Version</p>
<p>from pip._internal.distributions import make_distribution_for_install_requirement
from pip._internal.metadata import get_default_environment
from pip._internal.metadata.base import BaseDistribution
from pip._internal.req.req_install import InstallRequirement</p>
<p>logger = logging.getLogger(<strong>name</strong>)</p>
<p>class PackageDetails(NamedTuple):
version: Version
dependencies: list[Requirement]</p>
<section id="shorthands">
<h1>Shorthands<a class="headerlink" href="#shorthands" title="Link to this heading"></a></h1>
<p>PackageSet = dict[NormalizedName, PackageDetails]
Missing = tuple[NormalizedName, Requirement]
Conflicting = tuple[NormalizedName, Version, Requirement]</p>
<p>MissingDict = dict[NormalizedName, list[Missing]]
ConflictingDict = dict[NormalizedName, list[Conflicting]]
CheckResult = tuple[MissingDict, ConflictingDict]
ConflictDetails = tuple[PackageSet, CheckResult]</p>
<p>def create_package_set_from_installed() -&gt; tuple[PackageSet, bool]:
“””Converts a list of distributions into a PackageSet.”””
package_set = {}
problems = False
env = get_default_environment()
for dist in env.iter_installed_distributions(local_only=False, skip=()):
name = dist.canonical_name
try:
dependencies = list(dist.iter_dependencies())
package_set[name] = PackageDetails(dist.version, dependencies)
except (OSError, ValueError) as e:
# Don’t crash on unreadable or broken metadata.
logger.warning(“Error parsing dependencies of %s: %s”, name, e)
problems = True
return package_set, problems</p>
<p>def check_package_set(
package_set: PackageSet, should_ignore: Callable[[str], bool] | None = None
) -&gt; CheckResult:
“””Check if a package set is consistent</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>If should_ignore is passed, it should be a callable that takes a
package name and returns a boolean.
&quot;&quot;&quot;

missing = {}
conflicting = {}

for package_name, package_detail in package_set.items():
    # Info about dependencies of package_name
    missing_deps: set[Missing] = set()
    conflicting_deps: set[Conflicting] = set()

    if should_ignore and should_ignore(package_name):
        continue

    for req in package_detail.dependencies:
        name = canonicalize_name(req.name)

        # Check if it&#39;s missing
        if name not in package_set:
            missed = True
            if req.marker is not None:
                missed = req.marker.evaluate({&quot;extra&quot;: &quot;&quot;})
            if missed:
                missing_deps.add((name, req))
            continue

        # Check if there&#39;s a conflict
        version = package_set[name].version
        if not req.specifier.contains(version, prereleases=True):
            conflicting_deps.add((name, version, req))

    if missing_deps:
        missing[package_name] = sorted(missing_deps, key=str)
    if conflicting_deps:
        conflicting[package_name] = sorted(conflicting_deps, key=str)

return missing, conflicting
</pre></div>
</div>
<p>def check_install_conflicts(to_install: list[InstallRequirement]) -&gt; ConflictDetails:
“””For checking if the dependency graph would be consistent after <br />
installing given requirements
“””
# Start from the current state
package_set, _ = create_package_set_from_installed()
# Install packages
would_be_installed = _simulate_installation_of(to_install, package_set)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Only warn about directly-dependent packages; create a whitelist of them
whitelist = _create_whitelist(would_be_installed, package_set)

return (
    package_set,
    check_package_set(
        package_set, should_ignore=lambda name: name not in whitelist
    ),
)
</pre></div>
</div>
<p>def check_unsupported(
packages: Iterable[BaseDistribution],
supported_tags: Iterable[Tag],
) -&gt; Generator[BaseDistribution, None, None]:
for p in packages:
with suppress(FileNotFoundError):
wheel_file = p.read_text(“WHEEL”)
wheel_tags: frozenset[Tag] = reduce(
frozenset.union,
map(parse_tag, Parser().parsestr(wheel_file).get_all(“Tag”, [])),
frozenset(),
)
if wheel_tags.isdisjoint(supported_tags):
yield p</p>
<p>def _simulate_installation_of(
to_install: list[InstallRequirement], package_set: PackageSet
) -&gt; set[NormalizedName]:
“””Computes the version of packages after installing to_install.”””
# Keep track of packages that were installed
installed = set()</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Modify it as installing requirement_set would (assuming no errors)
for inst_req in to_install:
    abstract_dist = make_distribution_for_install_requirement(inst_req)
    dist = abstract_dist.get_metadata_distribution()
    name = dist.canonical_name
    package_set[name] = PackageDetails(dist.version, list(dist.iter_dependencies()))

    installed.add(name)

return installed
</pre></div>
</div>
<p>def _create_whitelist(
would_be_installed: set[NormalizedName], package_set: PackageSet
) -&gt; set[NormalizedName]:
packages_affected = set(would_be_installed)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>for package_name in package_set:
    if package_name in packages_affected:
        continue

    for req in package_set[package_name].dependencies:
        if canonicalize_name(req.name) in packages_affected:
            packages_affected.add(package_name)
            break

return packages_affected
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>