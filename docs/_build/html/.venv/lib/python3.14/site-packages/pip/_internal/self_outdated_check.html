

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/self_outdated_check.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>from <strong>future</strong> import annotations</p>
<p>import datetime
import functools
import hashlib
import json
import logging
import optparse
import os.path
import sys
from dataclasses import dataclass
from typing import Any, Callable</p>
<p>from pip._vendor.packaging.version import Version
from pip._vendor.packaging.version import parse as parse_version
from pip._vendor.rich.console import Group
from pip._vendor.rich.markup import escape
from pip._vendor.rich.text import Text</p>
<p>from pip._internal.index.collector import LinkCollector
from pip._internal.index.package_finder import PackageFinder
from pip._internal.metadata import get_default_environment
from pip._internal.models.selection_prefs import SelectionPreferences
from pip._internal.network.session import PipSession
from pip._internal.utils.compat import WINDOWS
from pip._internal.utils.entrypoints import (
get_best_invocation_for_this_pip,
get_best_invocation_for_this_python,
)
from pip._internal.utils.filesystem import (
adjacent_tmp_file,
check_path_owner,
copy_directory_permissions,
replace,
)
from pip._internal.utils.misc import (
ExternallyManagedEnvironment,
check_externally_managed,
ensure_dir,
)</p>
<p>_WEEK = datetime.timedelta(days=7)</p>
<p>logger = logging.getLogger(<strong>name</strong>)</p>
<p>def _get_statefile_name(key: str) -&gt; str:
key_bytes = key.encode()
name = hashlib.sha224(key_bytes).hexdigest()
return name</p>
<p>def _convert_date(isodate: str) -&gt; datetime.datetime:
“””Convert an ISO format string to a date.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Handles the format 2020-01-22T14:24:01Z (trailing Z)
which is not supported by older versions of fromisoformat.
&quot;&quot;&quot;
return datetime.datetime.fromisoformat(isodate.replace(&quot;Z&quot;, &quot;+00:00&quot;))
</pre></div>
</div>
<p>class SelfCheckState:
def <strong>init</strong>(self, cache_dir: str) -&gt; None:
self._state: dict[str, Any] = {}
self._statefile_path = None</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    # Try to load the existing state
    if cache_dir:
        self._statefile_path = os.path.join(
            cache_dir, &quot;selfcheck&quot;, _get_statefile_name(self.key)
        )
        try:
            with open(self._statefile_path, encoding=&quot;utf-8&quot;) as statefile:
                self._state = json.load(statefile)
        except (OSError, ValueError, KeyError):
            # Explicitly suppressing exceptions, since we don&#39;t want to
            # error out if the cache file is invalid.
            pass

@property
def key(self) -&gt; str:
    return sys.prefix

def get(self, current_time: datetime.datetime) -&gt; str | None:
    &quot;&quot;&quot;Check if we have a not-outdated version loaded already.&quot;&quot;&quot;
    if not self._state:
        return None

    if &quot;last_check&quot; not in self._state:
        return None

    if &quot;pypi_version&quot; not in self._state:
        return None

    # Determine if we need to refresh the state
    last_check = _convert_date(self._state[&quot;last_check&quot;])
    time_since_last_check = current_time - last_check
    if time_since_last_check &gt; _WEEK:
        return None

    return self._state[&quot;pypi_version&quot;]

def set(self, pypi_version: str, current_time: datetime.datetime) -&gt; None:
    # If we do not have a path to cache in, don&#39;t bother saving.
    if not self._statefile_path:
        return

    statefile_directory = os.path.dirname(self._statefile_path)

    # Check to make sure that we own the directory
    if not check_path_owner(statefile_directory):
        return

    # Now that we&#39;ve ensured the directory is owned by this user, we&#39;ll go
    # ahead and make sure that all our directories are created.
    ensure_dir(statefile_directory)

    state = {
        # Include the key so it&#39;s easy to tell which pip wrote the
        # file.
        &quot;key&quot;: self.key,
        &quot;last_check&quot;: current_time.isoformat(),
        &quot;pypi_version&quot;: pypi_version,
    }

    text = json.dumps(state, sort_keys=True, separators=(&quot;,&quot;, &quot;:&quot;))

    with adjacent_tmp_file(self._statefile_path) as f:
        f.write(text.encode())
        copy_directory_permissions(statefile_directory, f)

    try:
        # Since we have a prefix-specific state file, we can just
        # overwrite whatever is there, no need to check.
        replace(f.name, self._statefile_path)
    except OSError:
        # Best effort.
        pass
</pre></div>
</div>
<p>&#64;dataclass
class UpgradePrompt:
old: str
new: str</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __rich__(self) -&gt; Group:
    if WINDOWS:
        pip_cmd = f&quot;{get_best_invocation_for_this_python()} -m pip&quot;
    else:
        pip_cmd = get_best_invocation_for_this_pip()

    notice = &quot;[bold][[reset][blue]notice[reset][bold]][reset]&quot;
    return Group(
        Text(),
        Text.from_markup(
            f&quot;{notice} A new release of pip is available: &quot;
            f&quot;[red]{self.old}[reset] -&gt; [green]{self.new}[reset]&quot;
        ),
        Text.from_markup(
            f&quot;{notice} To update, run: &quot;
            f&quot;[green]{escape(pip_cmd)} install --upgrade pip&quot;
        ),
    )
</pre></div>
</div>
<p>def was_installed_by_pip(pkg: str) -&gt; bool:
“””Checks whether pkg was installed by pip</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This is used not to display the upgrade message when pip is in fact
installed by system package manager, such as dnf on Fedora.
&quot;&quot;&quot;
dist = get_default_environment().get_distribution(pkg)
return dist is not None and &quot;pip&quot; == dist.installer
</pre></div>
</div>
<p>def _get_current_remote_pip_version(
session: PipSession, options: optparse.Values
) -&gt; str | None:
# Lets use PackageFinder to see what the latest pip version is
link_collector = LinkCollector.create(
session,
options=options,
suppress_no_index=True,
)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Pass allow_yanked=False so we don&#39;t suggest upgrading to a
# yanked version.
selection_prefs = SelectionPreferences(
    allow_yanked=False,
    allow_all_prereleases=False,  # Explicitly set to False
)

finder = PackageFinder.create(
    link_collector=link_collector,
    selection_prefs=selection_prefs,
)
best_candidate = finder.find_best_candidate(&quot;pip&quot;).best_candidate
if best_candidate is None:
    return None

return str(best_candidate.version)
</pre></div>
</div>
<p>def _self_version_check_logic(
*,
state: SelfCheckState,
current_time: datetime.datetime,
local_version: Version,
get_remote_version: Callable[[], str | None],
) -&gt; UpgradePrompt | None:
remote_version_str = state.get(current_time)
if remote_version_str is None:
remote_version_str = get_remote_version()
if remote_version_str is None:
logger.debug(“No remote pip version found”)
return None
state.set(remote_version_str, current_time)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>remote_version = parse_version(remote_version_str)
logger.debug(&quot;Remote version of pip: %s&quot;, remote_version)
logger.debug(&quot;Local version of pip:  %s&quot;, local_version)

pip_installed_by_pip = was_installed_by_pip(&quot;pip&quot;)
logger.debug(&quot;Was pip installed by pip? %s&quot;, pip_installed_by_pip)
if not pip_installed_by_pip:
    return None  # Only suggest upgrade if pip is installed by pip.

local_version_is_older = (
    local_version &lt; remote_version
    and local_version.base_version != remote_version.base_version
)
if local_version_is_older:
    return UpgradePrompt(old=str(local_version), new=remote_version_str)

return None
</pre></div>
</div>
<p>def pip_self_version_check(session: PipSession, options: optparse.Values) -&gt; None:
“””Check for an update for pip.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Limit the frequency of checks to once per week. State is stored either in
the active virtualenv or in the user&#39;s USER_CACHE_DIR keyed off the prefix
of the pip script path.
&quot;&quot;&quot;
installed_dist = get_default_environment().get_distribution(&quot;pip&quot;)
if not installed_dist:
    return
try:
    check_externally_managed()
except ExternallyManagedEnvironment:
    return

upgrade_prompt = _self_version_check_logic(
    state=SelfCheckState(cache_dir=options.cache_dir),
    current_time=datetime.datetime.now(datetime.timezone.utc),
    local_version=installed_dist.version,
    get_remote_version=functools.partial(
        _get_current_remote_pip_version, session, options
    ),
)
if upgrade_prompt is not None:
    logger.warning(&quot;%s&quot;, upgrade_prompt, extra={&quot;rich&quot;: True})
</pre></div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>