

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/utils/subprocess.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>from <strong>future</strong> import annotations</p>
<p>import logging
import os
import shlex
import subprocess
from collections.abc import Iterable, Mapping
from typing import Any, Callable, Literal, Union</p>
<p>from pip._vendor.rich.markup import escape</p>
<p>from pip._internal.cli.spinners import SpinnerInterface, open_spinner
from pip._internal.exceptions import InstallationSubprocessError
from pip._internal.utils.logging import VERBOSE, subprocess_logger
from pip._internal.utils.misc import HiddenText</p>
<p>CommandArgs = list[Union[str, HiddenText]]</p>
<p>def make_command(*args: str | HiddenText | CommandArgs) -&gt; CommandArgs:
“””
Create a CommandArgs object.
“””
command_args: CommandArgs = []
for arg in args:
# Check for list instead of CommandArgs since CommandArgs is
# only known during type-checking.
if isinstance(arg, list):
command_args.extend(arg)
else:
# Otherwise, arg is str or HiddenText.
command_args.append(arg)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>return command_args
</pre></div>
</div>
<p>def format_command_args(args: list[str] | CommandArgs) -&gt; str:
“””
Format command arguments for display.
“””
# For HiddenText arguments, display the redacted form by calling str().
# Also, we don’t apply str() to arguments that aren’t HiddenText since
# this can trigger a UnicodeDecodeError in Python 2 if the argument
# has type unicode and includes a non-ascii character.  (The type
# checker doesn’t ensure the annotations are correct in all cases.)
return “ “.join(
shlex.quote(str(arg)) if isinstance(arg, HiddenText) else shlex.quote(arg)
for arg in args
)</p>
<p>def reveal_command_args(args: list[str] | CommandArgs) -&gt; list[str]:
“””
Return the arguments in their raw, unredacted form.
“””
return [arg.secret if isinstance(arg, HiddenText) else arg for arg in args]</p>
<p>def call_subprocess(
cmd: list[str] | CommandArgs,
show_stdout: bool = False,
cwd: str | None = None,
on_returncode: Literal[“raise”, “warn”, “ignore”] = “raise”,
extra_ok_returncodes: Iterable[int] | None = None,
extra_environ: Mapping[str, Any] | None = None,
unset_environ: Iterable[str] | None = None,
spinner: SpinnerInterface | None = None,
log_failed_cmd: bool | None = True,
stdout_only: bool | None = False,
*,
command_desc: str,
) -&gt; str:
“””
Args:
show_stdout: if true, use INFO to log the subprocess’s stderr and
stdout streams.  Otherwise, use DEBUG.  Defaults to False.
extra_ok_returncodes: an iterable of integer return codes that are
acceptable, in addition to 0. Defaults to None, which means [].
unset_environ: an iterable of environment variable names to unset
prior to calling subprocess.Popen().
log_failed_cmd: if false, failed commands are not logged, only raised.
stdout_only: if true, return only stdout, else return both. When true,
logging of both stdout and stderr occurs when the subprocess has
terminated, else logging occurs as subprocess output is produced.
“””
if extra_ok_returncodes is None:
extra_ok_returncodes = []
if unset_environ is None:
unset_environ = []
# Most places in pip use show_stdout=False. What this means is–
#
# - We connect the child’s output (combined stderr and stdout) to a
#   single pipe, which we read.
# - We log this output to stderr at DEBUG level as it is received.
# - If DEBUG logging isn’t enabled (e.g. if –verbose logging wasn’t
#   requested), then we show a spinner so the user can still see the
#   subprocess is in progress.
# - If the subprocess exits with an error, we log the output to stderr
#   at ERROR level if it hasn’t already been displayed to the console
#   (e.g. if –verbose logging wasn’t enabled).  This way we don’t log
#   the output to the console twice.
#
# If show_stdout=True, then the above is still done, but with DEBUG
# replaced by INFO.
if show_stdout:
# Then log the subprocess output at INFO level.
log_subprocess: Callable[…, None] = subprocess_logger.info
used_level = logging.INFO
else:
# Then log the subprocess output using VERBOSE.  This also ensures
# it will be logged to the log file (aka user_log), if enabled.
log_subprocess = subprocess_logger.verbose
used_level = VERBOSE</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Whether the subprocess will be visible in the console.
showing_subprocess = subprocess_logger.getEffectiveLevel() &lt;= used_level

# Only use the spinner if we&#39;re not showing the subprocess output
# and we have a spinner.
use_spinner = not showing_subprocess and spinner is not None

log_subprocess(&quot;Running command %s&quot;, command_desc)
env = os.environ.copy()
if extra_environ:
    env.update(extra_environ)
for name in unset_environ:
    env.pop(name, None)
try:
    proc = subprocess.Popen(
        # Convert HiddenText objects to the underlying str.
        reveal_command_args(cmd),
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT if not stdout_only else subprocess.PIPE,
        cwd=cwd,
        env=env,
        errors=&quot;backslashreplace&quot;,
    )
except Exception as exc:
    if log_failed_cmd:
        subprocess_logger.critical(
            &quot;Error %s while executing command %s&quot;,
            exc,
            command_desc,
        )
    raise
all_output = []
if not stdout_only:
    assert proc.stdout
    assert proc.stdin
    proc.stdin.close()
    # In this mode, stdout and stderr are in the same pipe.
    while True:
        line: str = proc.stdout.readline()
        if not line:
            break
        line = line.rstrip()
        all_output.append(line + &quot;\n&quot;)

        # Show the line immediately.
        log_subprocess(line)
        # Update the spinner.
        if use_spinner:
            assert spinner
            spinner.spin()
    try:
        proc.wait()
    finally:
        if proc.stdout:
            proc.stdout.close()
    output = &quot;&quot;.join(all_output)
else:
    # In this mode, stdout and stderr are in different pipes.
    # We must use communicate() which is the only safe way to read both.
    out, err = proc.communicate()
    # log line by line to preserve pip log indenting
    for out_line in out.splitlines():
        log_subprocess(out_line)
    all_output.append(out)
    for err_line in err.splitlines():
        log_subprocess(err_line)
    all_output.append(err)
    output = out

proc_had_error = proc.returncode and proc.returncode not in extra_ok_returncodes
if use_spinner:
    assert spinner
    if proc_had_error:
        spinner.finish(&quot;error&quot;)
    else:
        spinner.finish(&quot;done&quot;)
if proc_had_error:
    if on_returncode == &quot;raise&quot;:
        error = InstallationSubprocessError(
            command_description=command_desc,
            exit_code=proc.returncode,
            output_lines=all_output if not showing_subprocess else None,
        )
        if log_failed_cmd:
            subprocess_logger.error(&quot;%s&quot;, error, extra={&quot;rich&quot;: True})
            subprocess_logger.verbose(
                &quot;[bold magenta]full command[/]: [blue]%s[/]&quot;,
                escape(format_command_args(cmd)),
                extra={&quot;markup&quot;: True},
            )
            subprocess_logger.verbose(
                &quot;[bold magenta]cwd[/]: %s&quot;,
                escape(cwd or &quot;[inherit]&quot;),
                extra={&quot;markup&quot;: True},
            )

        raise error
    elif on_returncode == &quot;warn&quot;:
        subprocess_logger.warning(
            &#39;Command &quot;%s&quot; had error code %s in %s&#39;,
            command_desc,
            proc.returncode,
            cwd,
        )
    elif on_returncode == &quot;ignore&quot;:
        pass
    else:
        raise ValueError(f&quot;Invalid value: on_returncode={on_returncode!r}&quot;)
return output
</pre></div>
</div>
<p>def runner_with_spinner_message(message: str) -&gt; Callable[…, None]:
“””Provide a subprocess_runner that shows a spinner message.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Intended for use with for BuildBackendHookCaller. Thus, the runner has
an API that matches what&#39;s expected by BuildBackendHookCaller.subprocess_runner.
&quot;&quot;&quot;

def runner(
    cmd: list[str],
    cwd: str | None = None,
    extra_environ: Mapping[str, Any] | None = None,
) -&gt; None:
    with open_spinner(message) as spinner:
        call_subprocess(
            cmd,
            command_desc=message,
            cwd=cwd,
            extra_environ=extra_environ,
            spinner=spinner,
        )

return runner
</pre></div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>