

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/index/sources.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>from <strong>future</strong> import annotations</p>
<p>import logging
import mimetypes
import os
from collections import defaultdict
from collections.abc import Iterable
from typing import Callable</p>
<p>from pip._vendor.packaging.utils import (
InvalidSdistFilename,
InvalidWheelFilename,
canonicalize_name,
parse_sdist_filename,
parse_wheel_filename,
)</p>
<p>from pip._internal.models.candidate import InstallationCandidate
from pip._internal.models.link import Link
from pip._internal.utils.urls import path_to_url, url_to_path
from pip._internal.vcs import is_url</p>
<p>logger = logging.getLogger(<strong>name</strong>)</p>
<p>FoundCandidates = Iterable[InstallationCandidate]
FoundLinks = Iterable[Link]
CandidatesFromPage = Callable[[Link], Iterable[InstallationCandidate]]
PageValidator = Callable[[Link], bool]</p>
<p>class LinkSource:
&#64;property
def link(self) -&gt; Link | None:
“””Returns the underlying link, if there’s one.”””
raise NotImplementedError()</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def page_candidates(self) -&gt; FoundCandidates:
    &quot;&quot;&quot;Candidates found by parsing an archive listing HTML file.&quot;&quot;&quot;
    raise NotImplementedError()

def file_links(self) -&gt; FoundLinks:
    &quot;&quot;&quot;Links found by specifying archives directly.&quot;&quot;&quot;
    raise NotImplementedError()
</pre></div>
</div>
<p>def _is_html_file(file_url: str) -&gt; bool:
return mimetypes.guess_type(file_url, strict=False)[0] == “text/html”</p>
<p>class _FlatDirectoryToUrls:
“””Scans directory and caches results”””</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __init__(self, path: str) -&gt; None:
    self._path = path
    self._page_candidates: list[str] = []
    self._project_name_to_urls: dict[str, list[str]] = defaultdict(list)
    self._scanned_directory = False

def _scan_directory(self) -&gt; None:
    &quot;&quot;&quot;Scans directory once and populates both page_candidates
    and project_name_to_urls at the same time
    &quot;&quot;&quot;
    for entry in os.scandir(self._path):
        url = path_to_url(entry.path)
        if _is_html_file(url):
            self._page_candidates.append(url)
            continue

        # File must have a valid wheel or sdist name,
        # otherwise not worth considering as a package
        try:
            project_filename = parse_wheel_filename(entry.name)[0]
        except InvalidWheelFilename:
            try:
                project_filename = parse_sdist_filename(entry.name)[0]
            except InvalidSdistFilename:
                continue

        self._project_name_to_urls[project_filename].append(url)
    self._scanned_directory = True

@property
def page_candidates(self) -&gt; list[str]:
    if not self._scanned_directory:
        self._scan_directory()

    return self._page_candidates

@property
def project_name_to_urls(self) -&gt; dict[str, list[str]]:
    if not self._scanned_directory:
        self._scan_directory()

    return self._project_name_to_urls
</pre></div>
</div>
<p>class _FlatDirectorySource(LinkSource):
“””Link source specified by <code class="docutils literal notranslate"><span class="pre">--find-links=&lt;path-to-dir&gt;</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This looks the content of the directory, and returns:

* ``page_candidates``: Links listed on each HTML file in the directory.
* ``file_candidates``: Archives in the directory.
&quot;&quot;&quot;

_paths_to_urls: dict[str, _FlatDirectoryToUrls] = {}

def __init__(
    self,
    candidates_from_page: CandidatesFromPage,
    path: str,
    project_name: str,
) -&gt; None:
    self._candidates_from_page = candidates_from_page
    self._project_name = canonicalize_name(project_name)

    # Get existing instance of _FlatDirectoryToUrls if it exists
    if path in self._paths_to_urls:
        self._path_to_urls = self._paths_to_urls[path]
    else:
        self._path_to_urls = _FlatDirectoryToUrls(path=path)
        self._paths_to_urls[path] = self._path_to_urls

@property
def link(self) -&gt; Link | None:
    return None

def page_candidates(self) -&gt; FoundCandidates:
    for url in self._path_to_urls.page_candidates:
        yield from self._candidates_from_page(Link(url))

def file_links(self) -&gt; FoundLinks:
    for url in self._path_to_urls.project_name_to_urls[self._project_name]:
        yield Link(url)
</pre></div>
</div>
<p>class _LocalFileSource(LinkSource):
“””<code class="docutils literal notranslate"><span class="pre">--find-links=&lt;path-or-url&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">--[extra-]index-url=&lt;path-or-url&gt;</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>If a URL is supplied, it must be a ``file:`` URL. If a path is supplied to
the option, it is converted to a URL first. This returns:

* ``page_candidates``: Links listed on an HTML file.
* ``file_candidates``: The non-HTML file.
&quot;&quot;&quot;

def __init__(
    self,
    candidates_from_page: CandidatesFromPage,
    link: Link,
) -&gt; None:
    self._candidates_from_page = candidates_from_page
    self._link = link

@property
def link(self) -&gt; Link | None:
    return self._link

def page_candidates(self) -&gt; FoundCandidates:
    if not _is_html_file(self._link.url):
        return
    yield from self._candidates_from_page(self._link)

def file_links(self) -&gt; FoundLinks:
    if _is_html_file(self._link.url):
        return
    yield self._link
</pre></div>
</div>
<p>class _RemoteFileSource(LinkSource):
“””<code class="docutils literal notranslate"><span class="pre">--find-links=&lt;url&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">--[extra-]index-url=&lt;url&gt;</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This returns:

* ``page_candidates``: Links listed on an HTML file.
* ``file_candidates``: The non-HTML file.
&quot;&quot;&quot;

def __init__(
    self,
    candidates_from_page: CandidatesFromPage,
    page_validator: PageValidator,
    link: Link,
) -&gt; None:
    self._candidates_from_page = candidates_from_page
    self._page_validator = page_validator
    self._link = link

@property
def link(self) -&gt; Link | None:
    return self._link

def page_candidates(self) -&gt; FoundCandidates:
    if not self._page_validator(self._link):
        return
    yield from self._candidates_from_page(self._link)

def file_links(self) -&gt; FoundLinks:
    yield self._link
</pre></div>
</div>
<p>class _IndexDirectorySource(LinkSource):
“””<code class="docutils literal notranslate"><span class="pre">--[extra-]index-url=&lt;path-to-directory&gt;</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This is treated like a remote URL; ``candidates_from_page`` contains logic
for this by appending ``index.html`` to the link.
&quot;&quot;&quot;

def __init__(
    self,
    candidates_from_page: CandidatesFromPage,
    link: Link,
) -&gt; None:
    self._candidates_from_page = candidates_from_page
    self._link = link

@property
def link(self) -&gt; Link | None:
    return self._link

def page_candidates(self) -&gt; FoundCandidates:
    yield from self._candidates_from_page(self._link)

def file_links(self) -&gt; FoundLinks:
    return ()
</pre></div>
</div>
<p>def build_source(
location: str,
*,
candidates_from_page: CandidatesFromPage,
page_validator: PageValidator,
expand_dir: bool,
cache_link_parsing: bool,
project_name: str,
) -&gt; tuple[str | None, LinkSource | None]:
path: str | None = None
url: str | None = None
if os.path.exists(location):  # Is a local path.
url = path_to_url(location)
path = location
elif location.startswith(“file:”):  # A file: URL.
url = location
path = url_to_path(location)
elif is_url(location):
url = location</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if url is None:
    msg = (
        &quot;Location &#39;%s&#39; is ignored: &quot;
        &quot;it is either a non-existing path or lacks a specific scheme.&quot;
    )
    logger.warning(msg, location)
    return (None, None)

if path is None:
    source: LinkSource = _RemoteFileSource(
        candidates_from_page=candidates_from_page,
        page_validator=page_validator,
        link=Link(url, cache_link_parsing=cache_link_parsing),
    )
    return (url, source)

if os.path.isdir(path):
    if expand_dir:
        source = _FlatDirectorySource(
            candidates_from_page=candidates_from_page,
            path=path,
            project_name=project_name,
        )
    else:
        source = _IndexDirectorySource(
            candidates_from_page=candidates_from_page,
            link=Link(url, cache_link_parsing=cache_link_parsing),
        )
    return (url, source)
elif os.path.isfile(path):
    source = _LocalFileSource(
        candidates_from_page=candidates_from_page,
        link=Link(url, cache_link_parsing=cache_link_parsing),
    )
    return (url, source)
logger.warning(
    &quot;Location &#39;%s&#39; is ignored: it is neither a file nor a directory.&quot;,
    location,
)
return (url, None)
</pre></div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>