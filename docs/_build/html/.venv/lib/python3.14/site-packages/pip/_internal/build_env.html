

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/build_env.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>“””Build Environment used for isolation during sdist building”””</p>
<p>from <strong>future</strong> import annotations</p>
<p>import logging
import os
import pathlib
import site
import sys
import textwrap
from collections import OrderedDict
from collections.abc import Iterable
from types import TracebackType
from typing import TYPE_CHECKING, Protocol, TypedDict</p>
<p>from pip._vendor.packaging.version import Version</p>
<p>from pip import <strong>file</strong> as pip_location
from pip._internal.cli.spinners import open_spinner
from pip._internal.locations import get_platlib, get_purelib, get_scheme
from pip._internal.metadata import get_default_environment, get_environment
from pip._internal.utils.deprecation import deprecated
from pip._internal.utils.logging import VERBOSE
from pip._internal.utils.packaging import get_requirement
from pip._internal.utils.subprocess import call_subprocess
from pip._internal.utils.temp_dir import TempDirectory, tempdir_kinds</p>
<p>if TYPE_CHECKING:
from pip._internal.index.package_finder import PackageFinder
from pip._internal.req.req_install import InstallRequirement</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>class ExtraEnviron(TypedDict, total=False):
    extra_environ: dict[str, str]
</pre></div>
</div>
<p>logger = logging.getLogger(<strong>name</strong>)</p>
<p>def _dedup(a: str, b: str) -&gt; tuple[str] | tuple[str, str]:
return (a, b) if a != b else (a,)</p>
<p>class _Prefix:
def <strong>init</strong>(self, path: str) -&gt; None:
self.path = path
self.setup = False
scheme = get_scheme(“”, prefix=path)
self.bin_dir = scheme.scripts
self.lib_dirs = _dedup(scheme.purelib, scheme.platlib)</p>
<p>def get_runnable_pip() -&gt; str:
“””Get a file to pass to a Python executable, to run the currently-running pip.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This is used to run a pip subprocess, for installing requirements into the build
environment.
&quot;&quot;&quot;
source = pathlib.Path(pip_location).resolve().parent

if not source.is_dir():
    # This would happen if someone is using pip from inside a zip file. In that
    # case, we can use that directly.
    return str(source)

return os.fsdecode(source / &quot;__pip-runner__.py&quot;)
</pre></div>
</div>
<p>def _get_system_sitepackages() -&gt; set[str]:
“””Get system site packages</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Usually from site.getsitepackages,
but fallback on `get_purelib()/get_platlib()` if unavailable
(e.g. in a virtualenv created by virtualenv&lt;20)

Returns normalized set of strings.
&quot;&quot;&quot;
if hasattr(site, &quot;getsitepackages&quot;):
    system_sites = site.getsitepackages()
else:
    # virtualenv &lt; 20 overwrites site.py without getsitepackages
    # fallback on get_purelib/get_platlib.
    # this is known to miss things, but shouldn&#39;t in the cases
    # where getsitepackages() has been removed (inside a virtualenv)
    system_sites = [get_purelib(), get_platlib()]
return {os.path.normcase(path) for path in system_sites}
</pre></div>
</div>
<p>class BuildEnvironmentInstaller(Protocol):
“””
Interface for installing build dependencies into an isolated build
environment.
“””</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def install(
    self,
    requirements: Iterable[str],
    prefix: _Prefix,
    *,
    kind: str,
    for_req: InstallRequirement | None,
) -&gt; None: ...
</pre></div>
</div>
<p>class SubprocessBuildEnvironmentInstaller:
“””
Install build dependencies by calling pip in a subprocess.
“””</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __init__(
    self,
    finder: PackageFinder,
    build_constraints: list[str] | None = None,
    build_constraint_feature_enabled: bool = False,
) -&gt; None:
    self.finder = finder
    self._build_constraints = build_constraints or []
    self._build_constraint_feature_enabled = build_constraint_feature_enabled

def _deprecation_constraint_check(self) -&gt; None:
    &quot;&quot;&quot;
    Check for deprecation warning: PIP_CONSTRAINT affecting build environments.

    This warns when build-constraint feature is NOT enabled and PIP_CONSTRAINT
    is not empty.
    &quot;&quot;&quot;
    if self._build_constraint_feature_enabled or self._build_constraints:
        return

    pip_constraint = os.environ.get(&quot;PIP_CONSTRAINT&quot;)
    if not pip_constraint or not pip_constraint.strip():
        return

    deprecated(
        reason=(
            &quot;Setting PIP_CONSTRAINT will not affect &quot;
            &quot;build constraints in the future,&quot;
        ),
        replacement=(
            &quot;to specify build constraints using --build-constraint or &quot;
            &quot;PIP_BUILD_CONSTRAINT. To disable this warning without &quot;
            &quot;any build constraints set --use-feature=build-constraint or &quot;
            &#39;PIP_USE_FEATURE=&quot;build-constraint&quot;&#39;
        ),
        gone_in=&quot;26.2&quot;,
        issue=None,
    )

def install(
    self,
    requirements: Iterable[str],
    prefix: _Prefix,
    *,
    kind: str,
    for_req: InstallRequirement | None,
) -&gt; None:
    self._deprecation_constraint_check()

    finder = self.finder
    args: list[str] = [
        sys.executable,
        get_runnable_pip(),
        &quot;install&quot;,
        &quot;--ignore-installed&quot;,
        &quot;--no-user&quot;,
        &quot;--prefix&quot;,
        prefix.path,
        &quot;--no-warn-script-location&quot;,
        &quot;--disable-pip-version-check&quot;,
        # As the build environment is ephemeral, it&#39;s wasteful to
        # pre-compile everything, especially as not every Python
        # module will be used/compiled in most cases.
        &quot;--no-compile&quot;,
        # The prefix specified two lines above, thus
        # target from config file or env var should be ignored
        &quot;--target&quot;,
        &quot;&quot;,
    ]
    if logger.getEffectiveLevel() &lt;= logging.DEBUG:
        args.append(&quot;-vv&quot;)
    elif logger.getEffectiveLevel() &lt;= VERBOSE:
        args.append(&quot;-v&quot;)
    for format_control in (&quot;no_binary&quot;, &quot;only_binary&quot;):
        formats = getattr(finder.format_control, format_control)
        args.extend(
            (
                &quot;--&quot; + format_control.replace(&quot;_&quot;, &quot;-&quot;),
                &quot;,&quot;.join(sorted(formats or {&quot;:none:&quot;})),
            )
        )

    index_urls = finder.index_urls
    if index_urls:
        args.extend([&quot;-i&quot;, index_urls[0]])
        for extra_index in index_urls[1:]:
            args.extend([&quot;--extra-index-url&quot;, extra_index])
    else:
        args.append(&quot;--no-index&quot;)
    for link in finder.find_links:
        args.extend([&quot;--find-links&quot;, link])

    if finder.proxy:
        args.extend([&quot;--proxy&quot;, finder.proxy])
    for host in finder.trusted_hosts:
        args.extend([&quot;--trusted-host&quot;, host])
    if finder.custom_cert:
        args.extend([&quot;--cert&quot;, finder.custom_cert])
    if finder.client_cert:
        args.extend([&quot;--client-cert&quot;, finder.client_cert])
    if finder.allow_all_prereleases:
        args.append(&quot;--pre&quot;)
    if finder.prefer_binary:
        args.append(&quot;--prefer-binary&quot;)

    # Handle build constraints
    if self._build_constraint_feature_enabled:
        args.extend([&quot;--use-feature&quot;, &quot;build-constraint&quot;])

    if self._build_constraints:
        # Build constraints must be passed as both constraints
        # and build constraints, so that nested builds receive
        # build constraints
        for constraint_file in self._build_constraints:
            args.extend([&quot;--constraint&quot;, constraint_file])
            args.extend([&quot;--build-constraint&quot;, constraint_file])

    extra_environ: ExtraEnviron = {}
    if self._build_constraint_feature_enabled and not self._build_constraints:
        # If there are no build constraints but the build constraints
        # feature is enabled then we must ignore regular constraints
        # in the isolated build environment
        extra_environ = {&quot;extra_environ&quot;: {&quot;_PIP_IN_BUILD_IGNORE_CONSTRAINTS&quot;: &quot;1&quot;}}

    args.append(&quot;--&quot;)
    args.extend(requirements)

    identify_requirement = (
        f&quot; for {for_req.name}&quot; if for_req and for_req.name else &quot;&quot;
    )
    with open_spinner(f&quot;Installing {kind}&quot;) as spinner:
        call_subprocess(
            args,
            command_desc=f&quot;installing {kind}{identify_requirement}&quot;,
            spinner=spinner,
            **extra_environ,
        )
</pre></div>
</div>
<p>class BuildEnvironment:
“””Creates and manages an isolated environment to install build deps”””</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __init__(self, installer: BuildEnvironmentInstaller) -&gt; None:
    self.installer = installer
    temp_dir = TempDirectory(kind=tempdir_kinds.BUILD_ENV, globally_managed=True)

    self._prefixes = OrderedDict(
        (name, _Prefix(os.path.join(temp_dir.path, name)))
        for name in (&quot;normal&quot;, &quot;overlay&quot;)
    )

    self._bin_dirs: list[str] = []
    self._lib_dirs: list[str] = []
    for prefix in reversed(list(self._prefixes.values())):
        self._bin_dirs.append(prefix.bin_dir)
        self._lib_dirs.extend(prefix.lib_dirs)

    # Customize site to:
    # - ensure .pth files are honored
    # - prevent access to system site packages
    system_sites = _get_system_sitepackages()

    self._site_dir = os.path.join(temp_dir.path, &quot;site&quot;)
    if not os.path.exists(self._site_dir):
        os.mkdir(self._site_dir)
    with open(
        os.path.join(self._site_dir, &quot;sitecustomize.py&quot;), &quot;w&quot;, encoding=&quot;utf-8&quot;
    ) as fp:
        fp.write(
            textwrap.dedent(
                &quot;&quot;&quot;
            import os, site, sys

            # First, drop system-sites related paths.
            original_sys_path = sys.path[:]
            known_paths = set()
            for path in {system_sites!r}:
                site.addsitedir(path, known_paths=known_paths)
            system_paths = set(
                os.path.normcase(path)
                for path in sys.path[len(original_sys_path):]
            )
            original_sys_path = [
                path for path in original_sys_path
                if os.path.normcase(path) not in system_paths
            ]
            sys.path = original_sys_path

            # Second, add lib directories.
            # ensuring .pth file are processed.
            for path in {lib_dirs!r}:
                assert not path in sys.path
                site.addsitedir(path)
            &quot;&quot;&quot;
            ).format(system_sites=system_sites, lib_dirs=self._lib_dirs)
        )

def __enter__(self) -&gt; None:
    self._save_env = {
        name: os.environ.get(name, None)
        for name in (&quot;PATH&quot;, &quot;PYTHONNOUSERSITE&quot;, &quot;PYTHONPATH&quot;)
    }

    path = self._bin_dirs[:]
    old_path = self._save_env[&quot;PATH&quot;]
    if old_path:
        path.extend(old_path.split(os.pathsep))

    pythonpath = [self._site_dir]

    os.environ.update(
        {
            &quot;PATH&quot;: os.pathsep.join(path),
            &quot;PYTHONNOUSERSITE&quot;: &quot;1&quot;,
            &quot;PYTHONPATH&quot;: os.pathsep.join(pythonpath),
        }
    )

def __exit__(
    self,
    exc_type: type[BaseException] | None,
    exc_val: BaseException | None,
    exc_tb: TracebackType | None,
) -&gt; None:
    for varname, old_value in self._save_env.items():
        if old_value is None:
            os.environ.pop(varname, None)
        else:
            os.environ[varname] = old_value

def check_requirements(
    self, reqs: Iterable[str]
) -&gt; tuple[set[tuple[str, str]], set[str]]:
    &quot;&quot;&quot;Return 2 sets:
    - conflicting requirements: set of (installed, wanted) reqs tuples
    - missing requirements: set of reqs
    &quot;&quot;&quot;
    missing = set()
    conflicting = set()
    if reqs:
        env = (
            get_environment(self._lib_dirs)
            if hasattr(self, &quot;_lib_dirs&quot;)
            else get_default_environment()
        )
        for req_str in reqs:
            req = get_requirement(req_str)
            # We&#39;re explicitly evaluating with an empty extra value, since build
            # environments are not provided any mechanism to select specific extras.
            if req.marker is not None and not req.marker.evaluate({&quot;extra&quot;: &quot;&quot;}):
                continue
            dist = env.get_distribution(req.name)
            if not dist:
                missing.add(req_str)
                continue
            if isinstance(dist.version, Version):
                installed_req_str = f&quot;{req.name}=={dist.version}&quot;
            else:
                installed_req_str = f&quot;{req.name}==={dist.version}&quot;
            if not req.specifier.contains(dist.version, prereleases=True):
                conflicting.add((installed_req_str, req_str))
            # FIXME: Consider direct URL?
    return conflicting, missing

def install_requirements(
    self,
    requirements: Iterable[str],
    prefix_as_string: str,
    *,
    kind: str,
    for_req: InstallRequirement | None = None,
) -&gt; None:
    prefix = self._prefixes[prefix_as_string]
    assert not prefix.setup
    prefix.setup = True
    if not requirements:
        return
    self.installer.install(requirements, prefix, kind=kind, for_req=for_req)
</pre></div>
</div>
<p>class NoOpBuildEnvironment(BuildEnvironment):
“””A no-op drop-in replacement for BuildEnvironment”””</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __init__(self) -&gt; None:
    pass

def __enter__(self) -&gt; None:
    pass

def __exit__(
    self,
    exc_type: type[BaseException] | None,
    exc_val: BaseException | None,
    exc_tb: TracebackType | None,
) -&gt; None:
    pass

def cleanup(self) -&gt; None:
    pass

def install_requirements(
    self,
    requirements: Iterable[str],
    prefix_as_string: str,
    *,
    kind: str,
    for_req: InstallRequirement | None = None,
) -&gt; None:
    raise NotImplementedError()
</pre></div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>