

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>test_writable_dir and _test_writable_dir_win are copied from Flit, &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">test_writable_dir and _test_writable_dir_win are copied from Flit,</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/utils/filesystem.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>from <strong>future</strong> import annotations</p>
<p>import fnmatch
import os
import os.path
import random
import sys
from collections.abc import Generator
from contextlib import contextmanager
from tempfile import NamedTemporaryFile
from typing import Any, BinaryIO, cast</p>
<p>from pip._internal.utils.compat import get_path_uid
from pip._internal.utils.misc import format_size
from pip._internal.utils.retry import retry</p>
<p>def check_path_owner(path: str) -&gt; bool:
# If we don’t have a way to check the effective uid of this process, then
# we’ll just assume that we own the directory.
if sys.platform == “win32” or not hasattr(os, “geteuid”):
return True</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>assert os.path.isabs(path)

previous = None
while path != previous:
    if os.path.lexists(path):
        # Check if path is writable by current user.
        if os.geteuid() == 0:
            # Special handling for root user in order to handle properly
            # cases where users use sudo without -H flag.
            try:
                path_uid = get_path_uid(path)
            except OSError:
                return False
            return path_uid == 0
        else:
            return os.access(path, os.W_OK)
    else:
        previous, path = path, os.path.dirname(path)
return False  # assume we don&#39;t own the path
</pre></div>
</div>
<p>&#64;contextmanager
def adjacent_tmp_file(path: str, **kwargs: Any) -&gt; Generator[BinaryIO, None, None]:
“””Return a file-like object pointing to a tmp file next to path.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The file is created securely and is ensured to be written to disk
after the context reaches its end.

kwargs will be passed to tempfile.NamedTemporaryFile to control
the way the temporary file will be opened.
&quot;&quot;&quot;
with NamedTemporaryFile(
    delete=False,
    dir=os.path.dirname(path),
    prefix=os.path.basename(path),
    suffix=&quot;.tmp&quot;,
    **kwargs,
) as f:
    result = cast(BinaryIO, f)
    try:
        yield result
    finally:
        result.flush()
        os.fsync(result.fileno())
</pre></div>
</div>
<p>replace = retry(stop_after_delay=1, wait=0.25)(os.replace)</p>
<section id="test-writable-dir-and-test-writable-dir-win-are-copied-from-flit">
<h1>test_writable_dir and _test_writable_dir_win are copied from Flit,<a class="headerlink" href="#test-writable-dir-and-test-writable-dir-win-are-copied-from-flit" title="Link to this heading"></a></h1>
</section>
<section id="with-the-author-s-agreement-to-also-place-them-under-pip-s-license">
<h1>with the author’s agreement to also place them under pip’s license.<a class="headerlink" href="#with-the-author-s-agreement-to-also-place-them-under-pip-s-license" title="Link to this heading"></a></h1>
<p>def test_writable_dir(path: str) -&gt; bool:
“””Check if a directory is writable.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Uses os.access() on POSIX, tries creating files on Windows.
&quot;&quot;&quot;
# If the directory doesn&#39;t exist, find the closest parent that does.
while not os.path.isdir(path):
    parent = os.path.dirname(path)
    if parent == path:
        break  # Should never get here, but infinite loops are bad
    path = parent

if os.name == &quot;posix&quot;:
    return os.access(path, os.W_OK)

return _test_writable_dir_win(path)
</pre></div>
</div>
<p>def <em>test_writable_dir_win(path: str) -&gt; bool:
# os.access doesn’t work on Windows: http://bugs.python.org/issue2528
# and we can’t use tempfile: http://bugs.python.org/issue22107
basename = “accesstest_deleteme_fishfingers_custard</em>”
alphabet = “abcdefghijklmnopqrstuvwxyz0123456789”
for _ in range(10):
name = basename + “”.join(random.choice(alphabet) for _ in range(6))
file = os.path.join(path, name)
try:
fd = os.open(file, os.O_RDWR | os.O_CREAT | os.O_EXCL)
except FileExistsError:
pass
except PermissionError:
# This could be because there’s a directory with the same name.
# But it’s highly unlikely there’s a directory called that,
# so we’ll assume it’s because the parent dir is not writable.
# This could as well be because the parent dir is not readable,
# due to non-privileged user access.
return False
else:
os.close(fd)
os.unlink(file)
return True</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># This should never be reached
raise OSError(&quot;Unexpected condition testing for writable directory&quot;)
</pre></div>
</div>
<p>def find_files(path: str, pattern: str) -&gt; list[str]:
“””Returns a list of absolute paths of files beneath path, recursively,
with filenames which match the UNIX-style shell glob pattern.”””
result: list[str] = []
for root, _, files in os.walk(path):
matches = fnmatch.filter(files, pattern)
result.extend(os.path.join(root, f) for f in matches)
return result</p>
<p>def file_size(path: str) -&gt; int | float:
# If it’s a symlink, return 0.
if os.path.islink(path):
return 0
return os.path.getsize(path)</p>
<p>def format_file_size(path: str) -&gt; str:
return format_size(file_size(path))</p>
<p>def directory_size(path: str) -&gt; int | float:
size = 0.0
for root, _dirs, files in os.walk(path):
for filename in files:
file_path = os.path.join(root, filename)
size += file_size(file_path)
return size</p>
<p>def format_directory_size(path: str) -&gt; str:
return format_size(directory_size(path))</p>
<p>def copy_directory_permissions(directory: str, target_file: BinaryIO) -&gt; None:
mode = (
os.stat(directory).st_mode &amp; 0o666  # select read/write permissions of directory
| 0o600  # set owner read/write permissions
)
# Change permissions only if there is no risk of following a symlink.
if os.chmod in os.supports_fd:
os.chmod(target_file.fileno(), mode)
elif os.chmod in os.supports_follow_symlinks:
os.chmod(target_file.name, mode, follow_symlinks=False)</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>