

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Be noisy about incompatibilities if this platforms “should” be using &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Be noisy about incompatibilities if this platforms “should” be using</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/locations/__init__.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>from <strong>future</strong> import annotations</p>
<p>import functools
import logging
import os
import pathlib
import sys
import sysconfig
from typing import Any</p>
<p>from pip._internal.models.scheme import SCHEME_KEYS, Scheme
from pip._internal.utils.compat import WINDOWS
from pip._internal.utils.deprecation import deprecated
from pip._internal.utils.virtualenv import running_under_virtualenv</p>
<p>from . import _sysconfig
from .base import (
USER_CACHE_DIR,
get_major_minor_version,
get_src_prefix,
is_osx_framework,
site_packages,
user_site,
)</p>
<p><strong>all</strong> = [
“USER_CACHE_DIR”,
“get_bin_prefix”,
“get_bin_user”,
“get_major_minor_version”,
“get_platlib”,
“get_purelib”,
“get_scheme”,
“get_src_prefix”,
“site_packages”,
“user_site”,
]</p>
<p>logger = logging.getLogger(<strong>name</strong>)</p>
<p>_PLATLIBDIR: str = getattr(sys, “platlibdir”, “lib”)</p>
<p>_USE_SYSCONFIG_DEFAULT = sys.version_info &gt;= (3, 10)</p>
<p>def _should_use_sysconfig() -&gt; bool:
“””This function determines the value of _USE_SYSCONFIG.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>By default, pip uses sysconfig on Python 3.10+.
But Python distributors can override this decision by setting:
    sysconfig._PIP_USE_SYSCONFIG = True / False
Rationale in https://github.com/pypa/pip/issues/10647

This is a function for testability, but should be constant during any one
run.
&quot;&quot;&quot;
return bool(getattr(sysconfig, &quot;_PIP_USE_SYSCONFIG&quot;, _USE_SYSCONFIG_DEFAULT))
</pre></div>
</div>
<p>_USE_SYSCONFIG = _should_use_sysconfig()</p>
<p>if not _USE_SYSCONFIG:
# Import distutils lazily to avoid deprecation warnings,
# but import it soon enough that it is in memory and available during
# a pip reinstall.
from . import _distutils</p>
<section id="be-noisy-about-incompatibilities-if-this-platforms-should-be-using">
<h1>Be noisy about incompatibilities if this platforms “should” be using<a class="headerlink" href="#be-noisy-about-incompatibilities-if-this-platforms-should-be-using" title="Link to this heading"></a></h1>
</section>
<section id="sysconfig-but-is-explicitly-opting-out-and-using-distutils-instead">
<h1>sysconfig, but is explicitly opting out and using distutils instead.<a class="headerlink" href="#sysconfig-but-is-explicitly-opting-out-and-using-distutils-instead" title="Link to this heading"></a></h1>
<p>if _USE_SYSCONFIG_DEFAULT and not _USE_SYSCONFIG:
_MISMATCH_LEVEL = logging.WARNING
else:
_MISMATCH_LEVEL = logging.DEBUG</p>
<p>def _looks_like_bpo_44860() -&gt; bool:
“””The resolution to bpo-44860 will change this incorrect platlib.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>See &lt;https://bugs.python.org/issue44860&gt;.
&quot;&quot;&quot;
from distutils.command.install import INSTALL_SCHEMES

try:
    unix_user_platlib = INSTALL_SCHEMES[&quot;unix_user&quot;][&quot;platlib&quot;]
except KeyError:
    return False
return unix_user_platlib == &quot;$usersite&quot;
</pre></div>
</div>
<p>def _looks_like_red_hat_patched_platlib_purelib(scheme: dict[str, str]) -&gt; bool:
platlib = scheme[“platlib”]
if “/$platlibdir/” in platlib:
platlib = platlib.replace(“/$platlibdir/”, f”/{_PLATLIBDIR}/”)
if “/lib64/” not in platlib:
return False
unpatched = platlib.replace(“/lib64/”, “/lib/”)
return unpatched.replace(“$platbase/”, “$base/”) == scheme[“purelib”]</p>
<p>&#64;functools.cache
def _looks_like_red_hat_lib() -&gt; bool:
“””Red Hat patches platlib in unix_prefix and unix_home, but not purelib.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This is the only way I can see to tell a Red Hat-patched Python.
&quot;&quot;&quot;
from distutils.command.install import INSTALL_SCHEMES

return all(
    k in INSTALL_SCHEMES
    and _looks_like_red_hat_patched_platlib_purelib(INSTALL_SCHEMES[k])
    for k in (&quot;unix_prefix&quot;, &quot;unix_home&quot;)
)
</pre></div>
</div>
<p>&#64;functools.cache
def _looks_like_debian_scheme() -&gt; bool:
“””Debian adds two additional schemes.”””
from distutils.command.install import INSTALL_SCHEMES</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>return &quot;deb_system&quot; in INSTALL_SCHEMES and &quot;unix_local&quot; in INSTALL_SCHEMES
</pre></div>
</div>
<p>&#64;functools.cache
def _looks_like_red_hat_scheme() -&gt; bool:
“””Red Hat patches <code class="docutils literal notranslate"><span class="pre">sys.prefix</span></code> and <code class="docutils literal notranslate"><span class="pre">sys.exec_prefix</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Red Hat&#39;s ``00251-change-user-install-location.patch`` changes the install
command&#39;s ``prefix`` and ``exec_prefix`` to append ``&quot;/local&quot;``. This is
(fortunately?) done quite unconditionally, so we create a default command
object without any configuration to detect this.
&quot;&quot;&quot;
from distutils.command.install import install
from distutils.dist import Distribution

cmd: Any = install(Distribution())
cmd.finalize_options()
return (
    cmd.exec_prefix == f&quot;{os.path.normpath(sys.exec_prefix)}/local&quot;
    and cmd.prefix == f&quot;{os.path.normpath(sys.prefix)}/local&quot;
)
</pre></div>
</div>
<p>&#64;functools.cache
def _looks_like_slackware_scheme() -&gt; bool:
“””Slackware patches sysconfig but fails to patch distutils and site.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Slackware changes sysconfig&#39;s user scheme to use ``&quot;lib64&quot;`` for the lib
path, but does not do the same to the site module.
&quot;&quot;&quot;
if user_site is None:  # User-site not available.
    return False
try:
    paths = sysconfig.get_paths(scheme=&quot;posix_user&quot;, expand=False)
except KeyError:  # User-site not available.
    return False
return &quot;/lib64/&quot; in paths[&quot;purelib&quot;] and &quot;/lib64/&quot; not in user_site
</pre></div>
</div>
<p>&#64;functools.cache
def _looks_like_msys2_mingw_scheme() -&gt; bool:
“””MSYS2 patches distutils and sysconfig to use a UNIX-like scheme.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>However, MSYS2 incorrectly patches sysconfig ``nt`` scheme. The fix is
likely going to be included in their 3.10 release, so we ignore the warning.
See msys2/MINGW-packages#9319.

MSYS2 MINGW&#39;s patch uses lowercase ``&quot;lib&quot;`` instead of the usual uppercase,
and is missing the final ``&quot;site-packages&quot;``.
&quot;&quot;&quot;
paths = sysconfig.get_paths(&quot;nt&quot;, expand=False)
return all(
    &quot;Lib&quot; not in p and &quot;lib&quot; in p and not p.endswith(&quot;site-packages&quot;)
    for p in (paths[key] for key in (&quot;platlib&quot;, &quot;purelib&quot;))
)
</pre></div>
</div>
<p>&#64;functools.cache
def _warn_mismatched(old: pathlib.Path, new: pathlib.Path, *, key: str) -&gt; None:
issue_url = “https://github.com/pypa/pip/issues/10151”
message = (
“Value for %s does not match. Please report this to &lt;%s&gt;”
“\ndistutils: %s”
“\nsysconfig: %s”
)
logger.log(_MISMATCH_LEVEL, message, key, issue_url, old, new)</p>
<p>def _warn_if_mismatch(old: pathlib.Path, new: pathlib.Path, *, key: str) -&gt; bool:
if old == new:
return False
_warn_mismatched(old, new, key=key)
return True</p>
<p>&#64;functools.cache
def _log_context(
*,
user: bool = False,
home: str | None = None,
root: str | None = None,
prefix: str | None = None,
) -&gt; None:
parts = [
“Additional context:”,
“user = %r”,
“home = %r”,
“root = %r”,
“prefix = %r”,
]</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>logger.log(_MISMATCH_LEVEL, &quot;\n&quot;.join(parts), user, home, root, prefix)
</pre></div>
</div>
<p>def get_scheme(
dist_name: str,
user: bool = False,
home: str | None = None,
root: str | None = None,
isolated: bool = False,
prefix: str | None = None,
) -&gt; Scheme:
new = _sysconfig.get_scheme(
dist_name,
user=user,
home=home,
root=root,
isolated=isolated,
prefix=prefix,
)
if _USE_SYSCONFIG:
return new</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>old = _distutils.get_scheme(
    dist_name,
    user=user,
    home=home,
    root=root,
    isolated=isolated,
    prefix=prefix,
)

warning_contexts = []
for k in SCHEME_KEYS:
    old_v = pathlib.Path(getattr(old, k))
    new_v = pathlib.Path(getattr(new, k))

    if old_v == new_v:
        continue

    # distutils incorrectly put PyPy packages under ``site-packages/python``
    # in the ``posix_home`` scheme, but PyPy devs said they expect the
    # directory name to be ``pypy`` instead. So we treat this as a bug fix
    # and not warn about it. See bpo-43307 and python/cpython#24628.
    skip_pypy_special_case = (
        sys.implementation.name == &quot;pypy&quot;
        and home is not None
        and k in (&quot;platlib&quot;, &quot;purelib&quot;)
        and old_v.parent == new_v.parent
        and old_v.name.startswith(&quot;python&quot;)
        and new_v.name.startswith(&quot;pypy&quot;)
    )
    if skip_pypy_special_case:
        continue

    # sysconfig&#39;s ``osx_framework_user`` does not include ``pythonX.Y`` in
    # the ``include`` value, but distutils&#39;s ``headers`` does. We&#39;ll let
    # CPython decide whether this is a bug or feature. See bpo-43948.
    skip_osx_framework_user_special_case = (
        user
        and is_osx_framework()
        and k == &quot;headers&quot;
        and old_v.parent.parent == new_v.parent
        and old_v.parent.name.startswith(&quot;python&quot;)
    )
    if skip_osx_framework_user_special_case:
        continue

    # On Red Hat and derived Linux distributions, distutils is patched to
    # use &quot;lib64&quot; instead of &quot;lib&quot; for platlib.
    if k == &quot;platlib&quot; and _looks_like_red_hat_lib():
        continue

    # On Python 3.9+, sysconfig&#39;s posix_user scheme sets platlib against
    # sys.platlibdir, but distutils&#39;s unix_user incorrectly continues
    # using the same $usersite for both platlib and purelib. This creates a
    # mismatch when sys.platlibdir is not &quot;lib&quot;.
    skip_bpo_44860 = (
        user
        and k == &quot;platlib&quot;
        and not WINDOWS
        and _PLATLIBDIR != &quot;lib&quot;
        and _looks_like_bpo_44860()
    )
    if skip_bpo_44860:
        continue

    # Slackware incorrectly patches posix_user to use lib64 instead of lib,
    # but not usersite to match the location.
    skip_slackware_user_scheme = (
        user
        and k in (&quot;platlib&quot;, &quot;purelib&quot;)
        and not WINDOWS
        and _looks_like_slackware_scheme()
    )
    if skip_slackware_user_scheme:
        continue

    # Both Debian and Red Hat patch Python to place the system site under
    # /usr/local instead of /usr. Debian also places lib in dist-packages
    # instead of site-packages, but the /usr/local check should cover it.
    skip_linux_system_special_case = (
        not (user or home or prefix or running_under_virtualenv())
        and old_v.parts[1:3] == (&quot;usr&quot;, &quot;local&quot;)
        and len(new_v.parts) &gt; 1
        and new_v.parts[1] == &quot;usr&quot;
        and (len(new_v.parts) &lt; 3 or new_v.parts[2] != &quot;local&quot;)
        and (_looks_like_red_hat_scheme() or _looks_like_debian_scheme())
    )
    if skip_linux_system_special_case:
        continue

    # MSYS2 MINGW&#39;s sysconfig patch does not include the &quot;site-packages&quot;
    # part of the path. This is incorrect and will be fixed in MSYS.
    skip_msys2_mingw_bug = (
        WINDOWS and k in (&quot;platlib&quot;, &quot;purelib&quot;) and _looks_like_msys2_mingw_scheme()
    )
    if skip_msys2_mingw_bug:
        continue

    # CPython&#39;s POSIX install script invokes pip (via ensurepip) against the
    # interpreter located in the source tree, not the install site. This
    # triggers special logic in sysconfig that&#39;s not present in distutils.
    # https://github.com/python/cpython/blob/8c21941ddaf/Lib/sysconfig.py#L178-L194
    skip_cpython_build = (
        sysconfig.is_python_build(check_home=True)
        and not WINDOWS
        and k in (&quot;headers&quot;, &quot;include&quot;, &quot;platinclude&quot;)
    )
    if skip_cpython_build:
        continue

    warning_contexts.append((old_v, new_v, f&quot;scheme.{k}&quot;))

if not warning_contexts:
    return old

# Check if this path mismatch is caused by distutils config files. Those
# files will no longer work once we switch to sysconfig, so this raises a
# deprecation message for them.
default_old = _distutils.distutils_scheme(
    dist_name,
    user,
    home,
    root,
    isolated,
    prefix,
    ignore_config_files=True,
)
if any(default_old[k] != getattr(old, k) for k in SCHEME_KEYS):
    deprecated(
        reason=(
            &quot;Configuring installation scheme with distutils config files &quot;
            &quot;is deprecated and will no longer work in the near future. If you &quot;
            &quot;are using a Homebrew or Linuxbrew Python, please see discussion &quot;
            &quot;at https://github.com/Homebrew/homebrew-core/issues/76621&quot;
        ),
        replacement=None,
        gone_in=None,
    )
    return old

# Post warnings about this mismatch so user can report them back.
for old_v, new_v, key in warning_contexts:
    _warn_mismatched(old_v, new_v, key=key)
_log_context(user=user, home=home, root=root, prefix=prefix)

return old
</pre></div>
</div>
<p>def get_bin_prefix() -&gt; str:
new = _sysconfig.get_bin_prefix()
if _USE_SYSCONFIG:
return new</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>old = _distutils.get_bin_prefix()
if _warn_if_mismatch(pathlib.Path(old), pathlib.Path(new), key=&quot;bin_prefix&quot;):
    _log_context()
return old
</pre></div>
</div>
<p>def get_bin_user() -&gt; str:
return _sysconfig.get_scheme(“”, user=True).scripts</p>
<p>def _looks_like_deb_system_dist_packages(value: str) -&gt; bool:
“””Check if the value is Debian’s APT-controlled dist-packages.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Debian&#39;s ``distutils.sysconfig.get_python_lib()`` implementation returns the
default package path controlled by APT, but does not patch ``sysconfig`` to
do the same. This is similar to the bug worked around in ``get_scheme()``,
but here the default is ``deb_system`` instead of ``unix_local``. Ultimately
we can&#39;t do anything about this Debian bug, and this detection allows us to
skip the warning when needed.
&quot;&quot;&quot;
if not _looks_like_debian_scheme():
    return False
if value == &quot;/usr/lib/python3/dist-packages&quot;:
    return True
return False
</pre></div>
</div>
<p>def get_purelib() -&gt; str:
“””Return the default pure-Python lib location.”””
new = _sysconfig.get_purelib()
if _USE_SYSCONFIG:
return new</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>old = _distutils.get_purelib()
if _looks_like_deb_system_dist_packages(old):
    return old
if _warn_if_mismatch(pathlib.Path(old), pathlib.Path(new), key=&quot;purelib&quot;):
    _log_context()
return old
</pre></div>
</div>
<p>def get_platlib() -&gt; str:
“””Return the default platform-shared lib location.”””
new = _sysconfig.get_platlib()
if _USE_SYSCONFIG:
return new</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>from . import _distutils

old = _distutils.get_platlib()
if _looks_like_deb_system_dist_packages(old):
    return old
if _warn_if_mismatch(pathlib.Path(old), pathlib.Path(new), key=&quot;platlib&quot;):
    _log_context()
return old
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>