

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_vendor/tomli_w/_writer.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>from <strong>future</strong> import annotations</p>
<p>from collections.abc import Mapping
from datetime import date, datetime, time
from types import MappingProxyType</p>
<p>TYPE_CHECKING = False
if TYPE_CHECKING:
from collections.abc import Generator
from decimal import Decimal
from typing import IO, Any, Final</p>
<p>ASCII_CTRL = frozenset(chr(i) for i in range(32)) | frozenset(chr(127))
ILLEGAL_BASIC_STR_CHARS = frozenset(‘”') | ASCII_CTRL - frozenset(“\t”)
BARE_KEY_CHARS = frozenset(
“abcdefghijklmnopqrstuvwxyz” “ABCDEFGHIJKLMNOPQRSTUVWXYZ” “0123456789” “-_”
)
ARRAY_TYPES = (list, tuple)
MAX_LINE_LENGTH = 100</p>
<p>COMPACT_ESCAPES = MappingProxyType(
{
“\u0008”: “\b”,  # backspace
“\u000A”: “\n”,  # linefeed
“\u000C”: “\f”,  # form feed
“\u000D”: “\r”,  # carriage return
“\u0022”: ‘&quot;’,  # quote
“\u005C”: “\”,  # backslash
}
)</p>
<p>class Context:
def <strong>init</strong>(self, allow_multiline: bool, indent: int):
if indent &lt; 0:
raise ValueError(“Indent width must be non-negative”)
self.allow_multiline: Final = allow_multiline
# cache rendered inline tables (mapping from object id to rendered inline table)
self.inline_table_cache: Final[dict[int, str]] = {}
self.indent_str: Final = “ “ * indent</p>
<p>def dump(
obj: Mapping[str, Any],
fp: IO[bytes],
/,
*,
multiline_strings: bool = False,
indent: int = 4,
) -&gt; None:
ctx = Context(multiline_strings, indent)
for chunk in gen_table_chunks(obj, ctx, name=””):
fp.write(chunk.encode())</p>
<p>def dumps(
obj: Mapping[str, Any], /, *, multiline_strings: bool = False, indent: int = 4
) -&gt; str:
ctx = Context(multiline_strings, indent)
return “”.join(gen_table_chunks(obj, ctx, name=””))</p>
<p>def gen_table_chunks(
table: Mapping[str, Any],
ctx: Context,
*,
name: str,
inside_aot: bool = False,
) -&gt; Generator[str, None, None]:
yielded = False
literals = []
tables: list[tuple[str, Any, bool]] = []  # =&gt; [(key, value, inside_aot)]
for k, v in table.items():
if isinstance(v, Mapping):
tables.append((k, v, False))
elif is_aot(v) and not all(is_suitable_inline_table(t, ctx) for t in v):
tables.extend((k, t, True) for t in v)
else:
literals.append((k, v))</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if inside_aot or name and (literals or not tables):
    yielded = True
    yield f&quot;[[{name}]]\n&quot; if inside_aot else f&quot;[{name}]\n&quot;

if literals:
    yielded = True
    for k, v in literals:
        yield f&quot;{format_key_part(k)} = {format_literal(v, ctx)}\n&quot;

for k, v, in_aot in tables:
    if yielded:
        yield &quot;\n&quot;
    else:
        yielded = True
    key_part = format_key_part(k)
    display_name = f&quot;{name}.{key_part}&quot; if name else key_part
    yield from gen_table_chunks(v, ctx, name=display_name, inside_aot=in_aot)
</pre></div>
</div>
<p>def format_literal(obj: object, ctx: Context, *, nest_level: int = 0) -&gt; str:
if isinstance(obj, bool):
return “true” if obj else “false”
if isinstance(obj, (int, float, date, datetime)):
return str(obj)
if isinstance(obj, time):
if obj.tzinfo:
raise ValueError(“TOML does not support offset times”)
return str(obj)
if isinstance(obj, str):
return format_string(obj, allow_multiline=ctx.allow_multiline)
if isinstance(obj, ARRAY_TYPES):
return format_inline_array(obj, ctx, nest_level)
if isinstance(obj, Mapping):
return format_inline_table(obj, ctx)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Lazy import to improve module import time
from decimal import Decimal

if isinstance(obj, Decimal):
    return format_decimal(obj)
raise TypeError(
    f&quot;Object of type &#39;{type(obj).__qualname__}&#39; is not TOML serializable&quot;
)
</pre></div>
</div>
<p>def format_decimal(obj: Decimal) -&gt; str:
if obj.is_nan():
return “nan”
if obj.is_infinite():
return “-inf” if obj.is_signed() else “inf”
dec_str = str(obj).lower()
return dec_str if “.” in dec_str or “e” in dec_str else dec_str + “.0”</p>
<p>def format_inline_table(obj: Mapping, ctx: Context) -&gt; str:
# check cache first
obj_id = id(obj)
if obj_id in ctx.inline_table_cache:
return ctx.inline_table_cache[obj_id]</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if not obj:
    rendered = &quot;{}&quot;
else:
    rendered = (
        &quot;{ &quot;
        + &quot;, &quot;.join(
            f&quot;{format_key_part(k)} = {format_literal(v, ctx)}&quot;
            for k, v in obj.items()
        )
        + &quot; }&quot;
    )
ctx.inline_table_cache[obj_id] = rendered
return rendered
</pre></div>
</div>
<p>def format_inline_array(obj: tuple | list, ctx: Context, nest_level: int) -&gt; str:
if not obj:
return “[]”
item_indent = ctx.indent_str * (1 + nest_level)
closing_bracket_indent = ctx.indent_str * nest_level
return (
“[\n”
+ “,\n”.join(
item_indent + format_literal(item, ctx, nest_level=nest_level + 1)
for item in obj
)
+ f”,\n{closing_bracket_indent}]”
)</p>
<p>def format_key_part(part: str) -&gt; str:
try:
only_bare_key_chars = BARE_KEY_CHARS.issuperset(part)
except TypeError:
raise TypeError(
f”Invalid mapping key ‘{part}’ of type ‘{type(part).<strong>qualname</strong>}’.”
“ A string is required.”
) from None</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if part and only_bare_key_chars:
    return part
return format_string(part, allow_multiline=False)
</pre></div>
</div>
<p>def format_string(s: str, *, allow_multiline: bool) -&gt; str:
do_multiline = allow_multiline and “\n” in s
if do_multiline:
result = ‘”””\n’
s = s.replace(“\r\n”, “\n”)
else:
result = ‘”’</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pos = seq_start = 0
while True:
    try:
        char = s[pos]
    except IndexError:
        result += s[seq_start:pos]
        if do_multiline:
            return result + &#39;&quot;&quot;&quot;&#39;
        return result + &#39;&quot;&#39;
    if char in ILLEGAL_BASIC_STR_CHARS:
        result += s[seq_start:pos]
        if char in COMPACT_ESCAPES:
            if do_multiline and char == &quot;\n&quot;:
                result += &quot;\n&quot;
            else:
                result += COMPACT_ESCAPES[char]
        else:
            result += &quot;\\u&quot; + hex(ord(char))[2:].rjust(4, &quot;0&quot;)
        seq_start = pos + 1
    pos += 1
</pre></div>
</div>
<p>def is_aot(obj: Any) -&gt; bool:
“””Decides if an object behaves as an array of tables (i.e. a nonempty list
of dicts).”””
return bool(
isinstance(obj, ARRAY_TYPES)
and obj
and all(isinstance(v, Mapping) for v in obj)
)</p>
<p>def is_suitable_inline_table(obj: Mapping, ctx: Context) -&gt; bool:
“””Use heuristics to decide if the inline-style representation is a good
choice for a given table.”””
rendered_inline = f”{ctx.indent_str}{format_inline_table(obj, ctx)},”
return len(rendered_inline) &lt;= MAX_LINE_LENGTH and “\n” not in rendered_inline</p>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>