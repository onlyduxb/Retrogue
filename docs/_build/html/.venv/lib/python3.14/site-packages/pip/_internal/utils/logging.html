

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Retrogue 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/custom.css?v=a6a68382" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../_static/fonts.css?v=5583d106" />

  
      <script src="../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../index.html" class="icon icon-home">
            Retrogue
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../index.html">Retrogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../_sources/.venv/lib/python3.14/site-packages/pip/_internal/utils/logging.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>from <strong>future</strong> import annotations</p>
<p>import contextlib
import errno
import logging
import logging.handlers
import os
import sys
import threading
from collections.abc import Generator
from dataclasses import dataclass
from io import TextIOWrapper
from logging import Filter
from typing import Any, ClassVar</p>
<p>from pip._vendor.rich.console import (
Console,
ConsoleOptions,
ConsoleRenderable,
RenderableType,
RenderResult,
RichCast,
)
from pip._vendor.rich.highlighter import NullHighlighter
from pip._vendor.rich.logging import RichHandler
from pip._vendor.rich.segment import Segment
from pip._vendor.rich.style import Style</p>
<p>from pip._internal.utils._log import VERBOSE, getLogger
from pip._internal.utils.compat import WINDOWS
from pip._internal.utils.deprecation import DEPRECATION_MSG_PREFIX
from pip._internal.utils.misc import ensure_dir</p>
<p>_log_state = threading.local()
_stdout_console = None
_stderr_console = None
subprocess_logger = getLogger(“pip.subprocessor”)</p>
<p>class BrokenStdoutLoggingError(Exception):
“””
Raised if BrokenPipeError occurs for the stdout stream while logging.
“””</p>
<p>def _is_broken_pipe_error(exc_class: type[BaseException], exc: BaseException) -&gt; bool:
if exc_class is BrokenPipeError:
return True</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># On Windows, a broken pipe can show up as EINVAL rather than EPIPE:
# https://bugs.python.org/issue19612
# https://bugs.python.org/issue30418
if not WINDOWS:
    return False

return isinstance(exc, OSError) and exc.errno in (errno.EINVAL, errno.EPIPE)
</pre></div>
</div>
<p>&#64;contextlib.contextmanager
def indent_log(num: int = 2) -&gt; Generator[None, None, None]:
“””
A context manager which will cause the log output to be indented for any
log messages emitted inside it.
“””
# For thread-safety
_log_state.indentation = get_indentation()
_log_state.indentation += num
try:
yield
finally:
_log_state.indentation -= num</p>
<p>def get_indentation() -&gt; int:
return getattr(_log_state, “indentation”, 0)</p>
<p>class IndentingFormatter(logging.Formatter):
default_time_format = “%Y-%m-%dT%H:%M:%S”</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __init__(
    self,
    *args: Any,
    add_timestamp: bool = False,
    **kwargs: Any,
) -&gt; None:
    &quot;&quot;&quot;
    A logging.Formatter that obeys the indent_log() context manager.

    :param add_timestamp: A bool indicating output lines should be prefixed
        with their record&#39;s timestamp.
    &quot;&quot;&quot;
    self.add_timestamp = add_timestamp
    super().__init__(*args, **kwargs)

def get_message_start(self, formatted: str, levelno: int) -&gt; str:
    &quot;&quot;&quot;
    Return the start of the formatted log message (not counting the
    prefix to add to each line).
    &quot;&quot;&quot;
    if levelno &lt; logging.WARNING:
        return &quot;&quot;
    if formatted.startswith(DEPRECATION_MSG_PREFIX):
        # Then the message already has a prefix.  We don&#39;t want it to
        # look like &quot;WARNING: DEPRECATION: ....&quot;
        return &quot;&quot;
    if levelno &lt; logging.ERROR:
        return &quot;WARNING: &quot;

    return &quot;ERROR: &quot;

def format(self, record: logging.LogRecord) -&gt; str:
    &quot;&quot;&quot;
    Calls the standard formatter, but will indent all of the log message
    lines by our current indentation level.
    &quot;&quot;&quot;
    formatted = super().format(record)
    message_start = self.get_message_start(formatted, record.levelno)
    formatted = message_start + formatted

    prefix = &quot;&quot;
    if self.add_timestamp:
        prefix = f&quot;{self.formatTime(record)} &quot;
    prefix += &quot; &quot; * get_indentation()
    formatted = &quot;&quot;.join([prefix + line for line in formatted.splitlines(True)])
    return formatted
</pre></div>
</div>
<p>&#64;dataclass
class IndentedRenderable:
renderable: RenderableType
indent: int</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __rich_console__(
    self, console: Console, options: ConsoleOptions
) -&gt; RenderResult:
    segments = console.render(self.renderable, options)
    lines = Segment.split_lines(segments)
    for line in lines:
        yield Segment(&quot; &quot; * self.indent)
        yield from line
        yield Segment(&quot;\n&quot;)
</pre></div>
</div>
<p>class PipConsole(Console):
def on_broken_pipe(self) -&gt; None:
# Reraise the original exception, rich 13.8.0+ exits by default
# instead, preventing our handler from firing.
raise BrokenPipeError() from None</p>
<p>def get_console(*, stderr: bool = False) -&gt; Console:
if stderr:
assert _stderr_console is not None, “stderr rich console is missing!”
return _stderr_console
else:
assert _stdout_console is not None, “stdout rich console is missing!”
return _stdout_console</p>
<p>class RichPipStreamHandler(RichHandler):
KEYWORDS: ClassVar[list[str] | None] = []</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __init__(self, console: Console) -&gt; None:
    super().__init__(
        console=console,
        show_time=False,
        show_level=False,
        show_path=False,
        highlighter=NullHighlighter(),
    )

# Our custom override on Rich&#39;s logger, to make things work as we need them to.
def emit(self, record: logging.LogRecord) -&gt; None:
    style: Style | None = None

    # If we are given a diagnostic error to present, present it with indentation.
    if getattr(record, &quot;rich&quot;, False):
        assert isinstance(record.args, tuple)
        (rich_renderable,) = record.args
        assert isinstance(
            rich_renderable, (ConsoleRenderable, RichCast, str)
        ), f&quot;{rich_renderable} is not rich-console-renderable&quot;

        renderable: RenderableType = IndentedRenderable(
            rich_renderable, indent=get_indentation()
        )
    else:
        message = self.format(record)
        renderable = self.render_message(record, message)
        if record.levelno is not None:
            if record.levelno &gt;= logging.ERROR:
                style = Style(color=&quot;red&quot;)
            elif record.levelno &gt;= logging.WARNING:
                style = Style(color=&quot;yellow&quot;)

    try:
        self.console.print(renderable, overflow=&quot;ignore&quot;, crop=False, style=style)
    except Exception:
        self.handleError(record)

def handleError(self, record: logging.LogRecord) -&gt; None:
    &quot;&quot;&quot;Called when logging is unable to log some output.&quot;&quot;&quot;

    exc_class, exc = sys.exc_info()[:2]
    # If a broken pipe occurred while calling write() or flush() on the
    # stdout stream in logging&#39;s Handler.emit(), then raise our special
    # exception so we can handle it in main() instead of logging the
    # broken pipe error and continuing.
    if (
        exc_class
        and exc
        and self.console.file is sys.stdout
        and _is_broken_pipe_error(exc_class, exc)
    ):
        raise BrokenStdoutLoggingError()

    return super().handleError(record)
</pre></div>
</div>
<p>class BetterRotatingFileHandler(logging.handlers.RotatingFileHandler):
def _open(self) -&gt; TextIOWrapper:
ensure_dir(os.path.dirname(self.baseFilename))
return super()._open()</p>
<p>class MaxLevelFilter(Filter):
def <strong>init</strong>(self, level: int) -&gt; None:
self.level = level</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def filter(self, record: logging.LogRecord) -&gt; bool:
    return record.levelno &lt; self.level
</pre></div>
</div>
<p>class ExcludeLoggerFilter(Filter):
“””
A logging Filter that excludes records from a logger (or its children).
“””</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def filter(self, record: logging.LogRecord) -&gt; bool:
    # The base Filter class allows only records from a logger (or its
    # children).
    return not super().filter(record)
</pre></div>
</div>
<p>def setup_logging(verbosity: int, no_color: bool, user_log_file: str | None) -&gt; int:
“””Configures and sets up all of the logging</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Returns the requested logging level, as its integer value.
&quot;&quot;&quot;

# Determine the level to be logging at.
if verbosity &gt;= 2:
    level_number = logging.DEBUG
elif verbosity == 1:
    level_number = VERBOSE
elif verbosity == -1:
    level_number = logging.WARNING
elif verbosity == -2:
    level_number = logging.ERROR
elif verbosity &lt;= -3:
    level_number = logging.CRITICAL
else:
    level_number = logging.INFO

level = logging.getLevelName(level_number)

# The &quot;root&quot; logger should match the &quot;console&quot; level *unless* we also need
# to log to a user log file.
include_user_log = user_log_file is not None
if include_user_log:
    additional_log_file = user_log_file
    root_level = &quot;DEBUG&quot;
else:
    additional_log_file = &quot;/dev/null&quot;
    root_level = level

# Disable any logging besides WARNING unless we have DEBUG level logging
# enabled for vendored libraries.
vendored_log_level = &quot;WARNING&quot; if level in [&quot;INFO&quot;, &quot;ERROR&quot;] else &quot;DEBUG&quot;

# Shorthands for clarity
handler_classes = {
    &quot;stream&quot;: &quot;pip._internal.utils.logging.RichPipStreamHandler&quot;,
    &quot;file&quot;: &quot;pip._internal.utils.logging.BetterRotatingFileHandler&quot;,
}
handlers = [&quot;console&quot;, &quot;console_errors&quot;, &quot;console_subprocess&quot;] + (
    [&quot;user_log&quot;] if include_user_log else []
)
global _stdout_console, stderr_console
_stdout_console = PipConsole(file=sys.stdout, no_color=no_color, soft_wrap=True)
_stderr_console = PipConsole(file=sys.stderr, no_color=no_color, soft_wrap=True)

logging.config.dictConfig(
    {
        &quot;version&quot;: 1,
        &quot;disable_existing_loggers&quot;: False,
        &quot;filters&quot;: {
            &quot;exclude_warnings&quot;: {
                &quot;()&quot;: &quot;pip._internal.utils.logging.MaxLevelFilter&quot;,
                &quot;level&quot;: logging.WARNING,
            },
            &quot;restrict_to_subprocess&quot;: {
                &quot;()&quot;: &quot;logging.Filter&quot;,
                &quot;name&quot;: subprocess_logger.name,
            },
            &quot;exclude_subprocess&quot;: {
                &quot;()&quot;: &quot;pip._internal.utils.logging.ExcludeLoggerFilter&quot;,
                &quot;name&quot;: subprocess_logger.name,
            },
        },
        &quot;formatters&quot;: {
            &quot;indent&quot;: {
                &quot;()&quot;: IndentingFormatter,
                &quot;format&quot;: &quot;%(message)s&quot;,
            },
            &quot;indent_with_timestamp&quot;: {
                &quot;()&quot;: IndentingFormatter,
                &quot;format&quot;: &quot;%(message)s&quot;,
                &quot;add_timestamp&quot;: True,
            },
        },
        &quot;handlers&quot;: {
            &quot;console&quot;: {
                &quot;level&quot;: level,
                &quot;class&quot;: handler_classes[&quot;stream&quot;],
                &quot;console&quot;: _stdout_console,
                &quot;filters&quot;: [&quot;exclude_subprocess&quot;, &quot;exclude_warnings&quot;],
                &quot;formatter&quot;: &quot;indent&quot;,
            },
            &quot;console_errors&quot;: {
                &quot;level&quot;: &quot;WARNING&quot;,
                &quot;class&quot;: handler_classes[&quot;stream&quot;],
                &quot;console&quot;: _stderr_console,
                &quot;filters&quot;: [&quot;exclude_subprocess&quot;],
                &quot;formatter&quot;: &quot;indent&quot;,
            },
            # A handler responsible for logging to the console messages
            # from the &quot;subprocessor&quot; logger.
            &quot;console_subprocess&quot;: {
                &quot;level&quot;: level,
                &quot;class&quot;: handler_classes[&quot;stream&quot;],
                &quot;console&quot;: _stderr_console,
                &quot;filters&quot;: [&quot;restrict_to_subprocess&quot;],
                &quot;formatter&quot;: &quot;indent&quot;,
            },
            &quot;user_log&quot;: {
                &quot;level&quot;: &quot;DEBUG&quot;,
                &quot;class&quot;: handler_classes[&quot;file&quot;],
                &quot;filename&quot;: additional_log_file,
                &quot;encoding&quot;: &quot;utf-8&quot;,
                &quot;delay&quot;: True,
                &quot;formatter&quot;: &quot;indent_with_timestamp&quot;,
            },
        },
        &quot;root&quot;: {
            &quot;level&quot;: root_level,
            &quot;handlers&quot;: handlers,
        },
        &quot;loggers&quot;: {&quot;pip._vendor&quot;: {&quot;level&quot;: vendored_log_level}},
    }
)

return level_number
</pre></div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Adam Worsnip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>